<!-- Navigation Indicator -->
<div class="nav-indicator" id="navIndicator">
    <div class="nav-dots-container">
        <div class="nav-dot active" data-section="0" onclick="goToSection(0)"></div>
        <div class="nav-dot" data-section="1" onclick="goToSection(1)"></div>
        <div class="nav-dot" data-section="2" onclick="goToSection(2)"></div>
        <div class="nav-dot" data-section="3" onclick="goToSection(3)"></div>
    </div>
    <div class="nav-page-name" id="navPageName">Chat</div>
</div>

<script>
    console.log('üöÄ Navigation script loaded!');

    // Wrap everything in IIFE to avoid global scope pollution
    (function() {
        'use strict';

        console.log('üîß IIFE started');

        // Horizontal Navigation System
        let currentSection = 0;
        const totalSections = 4;
        let isNavigating = false;
        let touchStartX = 0;
        let touchEndX = 0;

        function updateNavigation() {
            console.log('üìç updateNavigation called - currentSection:', currentSection);

            const container = document.getElementById('horizontalContainer');
            const dots = document.querySelectorAll('.nav-dot');

            if (!container) {
                console.error('‚ùå Container not found!');
                return;
            }

            // Update container position
            if (currentSection === 0) {
                container.className = 'horizontal-container show-chat';
                console.log('üìÑ Showing CHAT section');
            } else if (currentSection === 1) {
                container.className = 'horizontal-container show-notes';
                console.log('üìù Showing NOTES section');
            } else if (currentSection === 2) {
                container.className = 'horizontal-container show-den';
                console.log('‚è±Ô∏è Showing DEN section');
            } else {
                container.className = 'horizontal-container show-flashcards';
                console.log('üÉè Showing FLASHCARDS section');
            }

            // Cleanup Vanta effect when leaving DEN section
            try {
                if (currentSection !== 2 && window.ambientMode && typeof window.ambientMode.deactivate === 'function' && window.ambientMode.vantaEffect) {
                    console.log('üåå Deactivating Vanta effect (leaving DEN)');
                    window.ambientMode.deactivate();
                }
            } catch (error) {
                console.warn('‚ö†Ô∏è Error deactivating ambient mode:', error);
            }

            // Hide/Show DEN controls based on current section
            // Using data attributes instead of inline styles for better CSS control
            try {
                const ambientToggle = document.getElementById('ambientToggle');
                const colorPickerContainer = document.getElementById('colorPickerContainer');

                console.log('üîç Ambient toggle element:', ambientToggle);
                console.log('üé® Color picker container:', colorPickerContainer);

                if (ambientToggle) {
                    if (currentSection === 2) {
                        console.log('‚úÖ ON DEN SECTION - SHOWING AMBIENT TOGGLE');

                        // Use data attribute instead of inline styles
                        ambientToggle.setAttribute('data-visible', 'true');
                        ambientToggle.removeAttribute('style'); // Remove any inline styles that might conflict

                        // Log computed styles for debugging
                        setTimeout(() => {
                            const computedStyles = window.getComputedStyle(ambientToggle);
                            console.log('üéØ Ambient Toggle Computed Styles:');
                            console.log('   - display:', computedStyles.display);
                            console.log('   - visibility:', computedStyles.visibility);
                            console.log('   - opacity:', computedStyles.opacity);
                            console.log('   - position:', computedStyles.position);
                            console.log('   - top:', computedStyles.top);
                            console.log('   - right:', computedStyles.right);
                            console.log('   - z-index:', computedStyles.zIndex);
                            console.log('   - pointer-events:', computedStyles.pointerEvents);

                            // Check if element is in viewport
                            const rect = ambientToggle.getBoundingClientRect();
                            console.log('üìè Ambient Toggle Position:');
                            console.log('   - top:', rect.top, 'left:', rect.left);
                            console.log('   - width:', rect.width, 'height:', rect.height);
                            console.log('   - in viewport:', rect.top >= 0 && rect.left >= 0 && rect.bottom <= window.innerHeight && rect.right <= window.innerWidth);
                        }, 50);

                    } else {
                        console.log('‚ùå NOT on DEN section - hiding ambient toggle');
                        ambientToggle.setAttribute('data-visible', 'false');
                    }
                } else {
                    console.error('‚ùå CRITICAL: ambientToggle element NOT FOUND in DOM!');
                    console.log('üîç Attempting to find it with querySelector...');
                    const toggle = document.querySelector('#ambientToggle');
                    console.log('   querySelector result:', toggle);

                    if (!toggle) {
                        console.log('üîç Checking all buttons with "ambient" in id:');
                        const allButtons = document.querySelectorAll('button[id*="ambient"], button[id*="Ambient"]');
                        console.log('   Found buttons:', allButtons);
                    }
                }

                if (colorPickerContainer) {
                    if (currentSection === 2 && window.ambientMode && window.ambientMode.isActive) {
                        console.log('üé® Showing color picker');
                        // Use data-visible attribute instead of inline styles
                        colorPickerContainer.setAttribute('data-visible', 'true');
                        colorPickerContainer.removeAttribute('style');
                    } else {
                        console.log('üé® Hiding color picker');
                        // Use data-visible attribute instead of inline styles
                        colorPickerContainer.setAttribute('data-visible', 'false');
                    }
                } else {
                    console.warn('‚ö†Ô∏è colorPickerContainer not found');
                }
            } catch (error) {
                console.error('‚ùå Error managing DEN controls visibility:', error);
                console.error('   Stack:', error.stack);
            }

            // Update navigation dots
            // Update dots
            dots.forEach((dot, index) => {
                if (index === currentSection) {
                    dot.classList.add('active');
                } else {
                    dot.classList.remove('active');
                }
            });

            // Update and show page name
            const pageNames = ['Chat', 'Notes', 'Den', 'Cards'];
            const pageNameEl = document.getElementById('navPageName');
            if (pageNameEl) {
                pageNameEl.textContent = pageNames[currentSection];
                pageNameEl.classList.add('visible');

                // Hide after 2 seconds
                setTimeout(() => {
                    pageNameEl.classList.remove('visible');
                }, 2000);
            }

            // Close read mode modal if open
            const readModal = document.getElementById('readModal');
            if (readModal && readModal.classList.contains('active')) {
                const closeReadMode = window.closeReadMode;
                if (typeof closeReadMode === 'function') {
                    closeReadMode();
                }
            }

            // Store current section
            sessionStorage.setItem('currentSection', currentSection);
        }

        function goToSection(sectionIndex) {
            console.log('üéØ goToSection called with index:', sectionIndex);
            if (sectionIndex >= 0 && sectionIndex < totalSections && !isNavigating) {
                currentSection = sectionIndex;
                isNavigating = true;
                updateNavigation();

                // Extra check after animation completes
                setTimeout(() => {
                    isNavigating = false;

                    // Double-check ambient toggle visibility after navigation completes
                    if (sectionIndex === 2) {
                        console.log('üîÑ Post-navigation check for DEN section');
                        const ambientToggle = document.getElementById('ambientToggle');
                        if (ambientToggle) {
                            console.log('üîÑ Ensuring ambient toggle is visible...');
                            ambientToggle.setAttribute('data-visible', 'true');
                            ambientToggle.removeAttribute('style'); // Remove any conflicting inline styles

                            setTimeout(() => {
                                const computedDisplay = window.getComputedStyle(ambientToggle).display;
                                console.log('üîÑ Post-check display:', computedDisplay);
                            }, 100);
                        } else {
                            console.error('üîÑ ‚ùå Still cannot find ambient toggle after navigation!');
                        }
                    }
                }, 600); // Match transition duration
            }
        }

        function navigateLeft() {
            if (currentSection > 0) {
                goToSection(currentSection - 1);
            }
        }

        function navigateRight() {
            if (currentSection < totalSections - 1) {
                goToSection(currentSection + 1);
            }
        }

        // Keyboard navigation handler
        function handleKeydown(e) {
            console.log('üîë Key pressed:', e.key, '| isNavigating:', isNavigating, '| Target:', e.target.tagName);

            // Ignore keyboard navigation when user is typing in input fields or editors
            const activeElement = document.activeElement;
            const isTyping = activeElement && (
                activeElement.tagName === 'INPUT' ||
                activeElement.tagName === 'TEXTAREA' ||
                activeElement.isContentEditable ||
                activeElement.classList.contains('ql-editor') ||
                activeElement.closest('.ql-editor')
            );

            if (isTyping) {
                console.log('‚å®Ô∏è User is typing in an input field, ignoring navigation');
                return;
            }

            if (isNavigating) {
                console.log('‚è∏Ô∏è Navigation in progress, ignoring key press');
                return;
            }

            if (e.key === 'ArrowLeft') {
                console.log('‚¨ÖÔ∏è Arrow Left detected - navigating left');
                e.preventDefault();
                navigateLeft();
            } else if (e.key === 'ArrowRight') {
                console.log('‚û°Ô∏è Arrow Right detected - navigating right');
                e.preventDefault();
                navigateRight();
            }
        }

        // Touch/Swipe navigation
        function handleTouchStart(e) {
            touchStartX = e.changedTouches[0].screenX;
        }

        function handleTouchEnd(e) {
            touchEndX = e.changedTouches[0].screenX;
            handleSwipe();
        }

        function handleSwipe() {
            const swipeThreshold = 50;
            const diff = touchStartX - touchEndX;

            if (Math.abs(diff) > swipeThreshold) {
                if (diff > 0) {
                    // Swiped left - go to next section
                    navigateRight();
                } else {
                    // Swiped right - go to previous section
                    navigateLeft();
                }
            }
        }

        // Mouse wheel navigation
        let wheelTimeout;
        function handleWheel(e) {
            if (isNavigating) return;

            clearTimeout(wheelTimeout);
            wheelTimeout = setTimeout(() => {
                if (Math.abs(e.deltaX) > Math.abs(e.deltaY)) {
                    // Horizontal scroll detected
                    if (e.deltaX > 0) {
                        navigateRight();
                    } else {
                        navigateLeft();
                    }
                }
            }, 50);
        }

        // Function to ensure DEN controls are visible when on DEN section
        function ensureDENControlsVisible() {
            if (currentSection === 2) {
                console.log('üîç ensureDENControlsVisible - forcing ambient toggle to show');
                const ambientToggle = document.getElementById('ambientToggle');
                if (ambientToggle) {
                    ambientToggle.setAttribute('data-visible', 'true');
                    ambientToggle.removeAttribute('style'); // Remove any inline styles
                    console.log('‚úÖ Ambient toggle data-visible set to true');

                    // Verify it worked
                    setTimeout(() => {
                        const computedStyles = window.getComputedStyle(ambientToggle);
                        console.log('‚úÖ Verified display:', computedStyles.display, 'opacity:', computedStyles.opacity);
                    }, 50);
                } else {
                    console.error('‚ùå Cannot find ambient toggle element');
                }
            }
        }

        // Initialize all event listeners and navigation
        function initializeNavigation() {
            console.log('*** NAVIGATION INITIALIZING ***');

            // Restore saved section
            const savedSection = parseInt(sessionStorage.getItem('currentSection') || '0');
            currentSection = savedSection;
            console.log('üìÇ Restored section from sessionStorage:', currentSection);

            updateNavigation();

            // Add all event listeners
            window.addEventListener('keydown', handleKeydown);
            window.addEventListener('touchstart', handleTouchStart);
            window.addEventListener('touchend', handleTouchEnd);
            window.addEventListener('wheel', handleWheel, { passive: true });

            // Force focus to body to enable immediate keyboard navigation
            if (document.body) {
                document.body.setAttribute('tabindex', '-1');
                document.body.focus();
                console.log('‚úÖ Focus set to body - keyboard events should now work immediately!');
            }

            console.log('*** KEYBOARD NAVIGATION READY - Arrow keys should work now! ***');
            console.log('üìã Event listener attached to window. Try pressing arrow keys...');

            // Extra check for DEN controls after short delay to ensure DOM is fully ready
            setTimeout(() => {
                console.log('‚è∞ Running delayed DEN controls check...');
                ensureDENControlsVisible();
            }, 100);
        }

        // Make goToSection globally accessible for onclick handlers
        window.goToSection = goToSection;

        // Initialize immediately if DOM is ready, otherwise wait
        console.log('üìÑ Document readyState:', document.readyState);
        if (document.readyState === 'loading') {
            console.log('‚è≥ Waiting for DOMContentLoaded...');
            document.addEventListener('DOMContentLoaded', initializeNavigation);
        } else {
            console.log('‚úÖ DOM already ready, initializing immediately...');
            initializeNavigation();
        }

        // Also initialize on window load as a fallback
        window.addEventListener('load', () => {
            console.log('ü™ü Window load event fired');

            // Restore saved section again in case it changed
            const savedSection = parseInt(sessionStorage.getItem('currentSection') || '0');
            if (savedSection !== currentSection) {
                console.log('üîÑ Section changed during load, updating:', savedSection);
                currentSection = savedSection;
                updateNavigation();
            }

            // Ensure focus is set again on window load
            if (document.body) {
                document.body.focus();
                console.log('üîÑ Focus re-applied on window load');
            }

            // Final check for DEN controls
            setTimeout(() => {
                console.log('‚è∞ Final DEN controls visibility check on window load...');
                ensureDENControlsVisible();
            }, 200);
        });

        // Expose function globally for manual debugging
        window.debugAmbientToggle = function() {
            console.log('üêõ MANUAL DEBUG - Current Section:', currentSection);
            const toggle = document.getElementById('ambientToggle');
            console.log('üêõ Toggle element:', toggle);
            if (toggle) {
                const styles = window.getComputedStyle(toggle);
                console.log('üêõ Computed styles:', {
                    display: styles.display,
                    visibility: styles.visibility,
                    opacity: styles.opacity,
                    position: styles.position,
                    top: styles.top,
                    right: styles.right,
                    zIndex: styles.zIndex
                });
                const rect = toggle.getBoundingClientRect();
                console.log('üêõ Position:', rect);
            }
        };

        // Expose function to force show toggle
        window.forceShowAmbientToggle = function() {
            console.log('üîß FORCE SHOWING AMBIENT TOGGLE');
            const toggle = document.getElementById('ambientToggle');
            if (toggle) {
                toggle.setAttribute('data-visible', 'true');
                toggle.removeAttribute('style');
                console.log('‚úÖ Force show applied via data-visible');

                setTimeout(() => {
                    const styles = window.getComputedStyle(toggle);
                    console.log('üîß After force:', {
                        display: styles.display,
                        visibility: styles.visibility,
                        opacity: styles.opacity
                    });
                }, 50);
            } else {
                console.error('‚ùå Cannot find toggle to force show');
            }
        };

    })();
</script>
