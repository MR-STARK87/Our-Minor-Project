<!-- DEN Section Content - Pomodoro Focus Timer -->
<style>
  /* Hide scrollbar for DEN content */
  #denScrollContent::-webkit-scrollbar {
    display: none;
    width: 0;
    height: 0;
  }

  #denScrollContent {
    scrollbar-width: none;
    -ms-overflow-style: none;
  }

  /* Grid layout improvements */
  @media (min-width: 768px) {
    .den-grid-container {
      display: grid;
      grid-template-columns: 1fr 1fr;
      grid-template-rows: auto auto auto;
      gap: 1rem;
      align-items: stretch;
    }

    .den-timer-card {
      grid-row: 1 / 3;
      grid-column: 1;
      align-self: stretch;
      display: flex;
      flex-direction: column;
    }

    .den-settings-card {
      grid-row: 1;
      grid-column: 2;
    }

    .den-stats-card {
      grid-row: 2;
      grid-column: 2;
    }

    .music-player-container {
      grid-row: 3;
      grid-column: 1 / 3;
    }
  }

  @media (max-width: 767px) {
    .den-grid-container {
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }
  }
</style>

<div style="height: 100%; display: flex; flex-direction: column; overflow: hidden; background: var(--bg-primary); position: relative;">
    <!-- Vanta.js Background Canvas -->
    <div
      id="vanta-bg"
      class="absolute inset-0 opacity-0 transition-opacity duration-1000 ease-in-out pointer-events-none"
      style="z-index: 0;"
    ></div>



    <div
      id="denScrollContent"
      class="h-full flex items-start justify-center p-4 relative overflow-y-auto"
    >
      <div class="w-full max-w-6xl den-grid-container mt-20">
        <!-- Main Timer Card -->
        <div
          class="bg-white rounded-3xl shadow-xl relative den-timer-card"
        >
          <!-- Kebab menu (3-dots) -->
          <button
            id="moreOptionsBtn"
            class="absolute top-3 right-3 w-9 h-9 rounded-full border border-gray-200 bg-white/90 backdrop-blur-sm shadow-sm flex items-center justify-center hover:bg-white focus:outline-none"
            aria-haspopup="true"
            aria-expanded="false"
            title="Options"
          >
            <span class="sr-only">More options</span>
            <svg
              xmlns="http://www.w3.org/2000/svg"
              fill="none"
              viewBox="0 0 24 24"
              stroke-width="1.5"
              stroke="currentColor"
              class="w-5 h-5 text-gray-600"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                d="M6.75 12a.75.75 0 1 1-1.5 0 .75.75 0 0 1 1.5 0Zm6 0a.75.75 0 1 1-1.5 0 .75.75 0 0 1 1.5 0Zm6 0a.75.75 0 1 1-1.5 0 .75.75 0 0 1 1.5 0Z"
              />
            </svg>
          </button>
          <div
            id="moreOptionsMenu"
            class="absolute top-12 right-3 bg-white/95 backdrop-blur-sm border border-gray-200 rounded-2xl shadow-xl p-2 w-56 dropdown-enter transition-all duration-150 z-20"
            role="menu"
            aria-labelledby="moreOptionsBtn"
          >
            <button
              id="optToggleCompact"
              class="w-full px-3 py-2 rounded-xl hover:bg-gray-100 text-sm text-gray-700 flex items-center justify-between"
              role="menuitem"
            >
              <span>Compact mode</span>
              <span id="chkCompact" class="text-purple-600 hidden">✓</span>
            </button>
            <button
              id="optToggleSettings"
              class="w-full px-3 py-2 rounded-xl hover:bg-gray-100 text-sm text-gray-700 flex items-center justify-between"
              role="menuitem"
            >
              <span>Show settings</span>
              <span id="chkSettings" class="text-purple-600">✓</span>
            </button>
            <button
              id="optToggleStats"
              class="w-full px-3 py-2 rounded-xl hover:bg-gray-100 text-sm text-gray-700 flex items-center justify-between"
              role="menuitem"
            >
              <span>Show statistics</span>
              <span id="chkStats" class="text-purple-600">✓</span>
            </button>
            <hr class="my-1 border-gray-200" />
            <button
              id="optToggleAmbient"
              class="w-full px-3 py-2 rounded-xl hover:bg-gray-100 text-sm text-gray-700 flex items-center justify-between"
              role="menuitem"
            >
              <span>Ambient mode</span>
              <span id="chkAmbient" class="text-purple-600">Off</span>
            </button>
            <button
              id="optOpenSky"
              class="w-full px-3 py-2 rounded-xl hover:bg-gray-100 text-sm text-gray-700 text-left"
              role="menuitem"
            >
              Sky color…
            </button>
            <hr class="my-1 border-gray-200" />
            <button
              id="optResetToday"
              class="w-full px-3 py-2 rounded-xl hover:bg-gray-100 text-sm text-red-600 text-left"
              role="menuitem"
            >
              Reset today
            </button>
          </div>

          <div class="px-6 py-6 sm:px-8 sm:py-8 card-padding flex-grow flex flex-col justify-center">
            <div
              class="grid items-center justify-center w-full grid-cols-1 text-center"
            >
              <!-- Header Section -->
              <div>
                <h1
                  class="text-lg font-medium tracking-tighter text-gray-600 lg:text-2xl font-space-grotesk"
                >
                  DEN
                </h1>
                <p
                  class="mt-2 text-sm text-gray-500 hidden-compact"
                  id="sessionType"
                >
                  Work Session • Stay Focused
                </p>
              </div>

              <!-- Timer Display -->
              <div class="mt-6 section-mt">
                <div
                  class="text-5xl font-light tracking-tight text-black font-mono font-space-grotesk"
                  id="timerDisplay"
                  role="timer"
                  aria-live="polite"
                >
                  25:00
                </div>
              </div>

              <!-- Progress Indicator -->
              <div class="mt-6 w-full section-mt">
                <div class="flex justify-between text-xs text-gray-500 mb-2">
                  <span>Session Progress</span>
                  <span id="progressText">0%</span>
                </div>
                <div class="w-full bg-gray-200 rounded-full h-2">
                  <div
                    class="bg-black h-2 rounded-full transition-all duration-500 ease-linear"
                    id="progressBar"
                    style="width: 0%"
                  ></div>
                </div>
              </div>

              <!-- Session Counter -->
              <div class="mt-4 flex justify-center items-center space-x-6">
                <div class="text-center">
                  <div
                    class="text-xl font-semibold text-black"
                    id="completedSessions"
                  >
                    0
                  </div>
                  <div class="text-xs text-gray-500">Completed</div>
                </div>
                <div class="w-px h-6 bg-gray-300"></div>
                <div class="text-center">
                  <div
                    class="text-xl font-semibold text-black"
                    id="currentSession"
                  >
                    1
                  </div>
                  <div class="text-xs text-gray-500">Current</div>
                </div>
              </div>
            </div>
          </div>

          <!-- Controls Section -->
          <div class="flex flex-col px-6 pb-6 sm:px-8 space-y-3 card-padding">
            <!-- Main Action Button -->
            <button
              id="startPauseBtn"
              class="flex items-center justify-center w-full px-6 py-3 text-center text-white duration-200 bg-black border-2 border-black rounded-full hover:bg-transparent hover:border-black hover:text-black focus:outline-none focus-visible:outline-black text-base focus-visible:ring-black font-medium"
            >
              <span>Start Focus</span>
            </button>

            <!-- Secondary Actions -->
            <div class="flex space-x-3 controls-gap">
              <button
                id="resetBtn"
                class="secondary-btn flex-1 px-4 py-2.5 text-center text-gray-600 duration-200 bg-transparent border-2 border-gray-300 rounded-full hover:bg-gray-50 hover:border-gray-400 focus:outline-none text-sm"
                title="R"
              >
                Reset
              </button>
              <button
                id="skipBtn"
                class="secondary-btn flex-1 px-4 py-2.5 text-center text-gray-600 duration-200 bg-transparent border-2 border-gray-300 rounded-full hover:bg-gray-50 hover:border-gray-400 focus:outline-none text-sm"
                title="S"
              >
                Skip
              </button>
            </div>
          </div>
        </div>

        <!-- Settings Card -->
        <div
          id="settingsCard"
          class="flex flex-col bg-white rounded-3xl shadow-lg h-fit den-settings-card"
        >
          <div class="px-6 py-4">
            <h3
              class="text-base font-medium text-gray-600 mb-3 font-space-grotesk"
            >
              Session Settings
            </h3>

            <div class="space-y-3">
              <!-- Work Duration -->
              <div class="flex justify-between items-center">
                <span class="text-sm text-gray-600">Work Duration</span>
                <div class="flex items-center space-x-2">
                  <button
                    class="w-7 h-7 rounded-full bg-gray-100 hover:bg-gray-200 flex items-center justify-center text-sm"
                    onclick="adjustTime('work', -5)"
                    aria-label="Decrease work duration"
                  >
                    -
                  </button>
                  <span
                    class="w-10 text-center text-sm font-medium"
                    id="workDuration"
                    >25</span
                  >
                  <button
                    class="w-7 h-7 rounded-full bg-gray-100 hover:bg-gray-200 flex items-center justify-center text-sm"
                    onclick="adjustTime('work', 5)"
                    aria-label="Increase work duration"
                  >
                    +
                  </button>
                </div>
              </div>

              <!-- Break Duration -->
              <div class="flex justify-between items-center">
                <span class="text-sm text-gray-600">Short Break</span>
                <div class="flex items-center space-x-2">
                  <button
                    class="w-7 h-7 rounded-full bg-gray-100 hover:bg-gray-200 flex items-center justify-center text-sm"
                    onclick="adjustTime('break', -1)"
                    aria-label="Decrease short break"
                  >
                    -
                  </button>
                  <span
                    class="w-10 text-center text-sm font-medium"
                    id="breakDuration"
                    >5</span
                  >
                  <button
                    class="w-7 h-7 rounded-full bg-gray-100 hover:bg-gray-200 flex items-center justify-center text-sm"
                    onclick="adjustTime('break', 1)"
                    aria-label="Increase short break"
                  >
                    +
                  </button>
                </div>
              </div>

              <!-- Long Break Duration -->
              <div class="flex justify-between items-center">
                <span class="text-sm text-gray-600">Long Break</span>
                <div class="flex items-center space-x-2">
                  <button
                    class="w-7 h-7 rounded-full bg-gray-100 hover:bg-gray-200 flex items-center justify-center text-sm"
                    onclick="adjustTime('longBreak', -5)"
                    aria-label="Decrease long break"
                  >
                    -
                  </button>
                  <span
                    class="w-10 text-center text-sm font-medium"
                    id="longBreakDuration"
                    >15</span
                  >
                  <button
                    class="w-7 h-7 rounded-full bg-gray-100 hover:bg-gray-200 flex items-center justify-center text-sm"
                    onclick="adjustTime('longBreak', 5)"
                    aria-label="Increase long break"
                  >
                    +
                  </button>
                </div>
              </div>

              <hr class="my-2 border-gray-200" />

              <!-- Auto-start next -->
              <div class="flex justify-between items-center">
                <span class="text-sm text-gray-600">Auto-start next</span>
                <label class="inline-flex items-center cursor-pointer">
                  <input id="autoStartToggle" type="checkbox" class="sr-only" />
                  <span
                    class="w-10 h-6 bg-gray-300 rounded-full relative transition-colors duration-200"
                    aria-hidden="true"
                  >
                    <span
                      id="autoStartKnob"
                      class="absolute left-1 top-1 w-4 h-4 bg-white rounded-full transition-transform duration-200"
                    ></span>
                  </span>
                </label>
              </div>

              <!-- Sound alerts -->
              <div class="flex justify-between items-center">
                <span class="text-sm text-gray-600">Sound alert</span>
                <label class="inline-flex items-center cursor-pointer">
                  <input id="soundToggle" type="checkbox" class="sr-only" />
                  <span
                    class="w-10 h-6 bg-gray-300 rounded-full relative transition-colors duration-200"
                  >
                    <span
                      id="soundKnob"
                      class="absolute left-1 top-1 w-4 h-4 bg-white rounded-full transition-transform duration-200"
                    ></span>
                  </span>
                </label>
              </div>

              <!-- Desktop notifications -->
              <div class="flex justify-between items-center">
                <span class="text-sm text-gray-600">Desktop notifications</span>
                <label class="inline-flex items-center cursor-pointer">
                  <input id="notifToggle" type="checkbox" class="sr-only" />
                  <span
                    class="w-10 h-6 bg-gray-300 rounded-full relative transition-colors duration-200"
                  >
                    <span
                      id="notifKnob"
                      class="absolute left-1 top-1 w-4 h-4 bg-white rounded-full transition-transform duration-200"
                    ></span>
                  </span>
                </label>
              </div>
            </div>
          </div>
        </div>

        <!-- Statistics Card -->
        <div
          id="statsCard"
          class="flex flex-col bg-white rounded-3xl shadow-lg h-fit den-stats-card"
        >
          <div class="px-6 py-4">
            <h3
              class="text-base font-medium text-gray-600 mb-3 font-space-grotesk"
            >
              Today's Progress
            </h3>

            <div class="grid grid-cols-3 gap-4">
              <div class="text-center">
                <div
                  class="text-lg font-semibold text-black"
                  id="todaysSessions"
                >
                  0
                </div>
                <div class="text-xs text-gray-500">Sessions</div>
              </div>
              <div class="text-center">
                <div class="text-lg font-semibold text-black" id="todaysTime">
                  0h
                </div>
                <div class="text-xs text-gray-500">Focus Time</div>
              </div>
              <div class="text-center">
                <div class="text-lg font-semibold text-black" id="streak">
                  0
                </div>
                <div class="text-xs text-gray-500">Day Streak</div>
              </div>
            </div>
          </div>
        </div>

        <!-- Music Player - Pill Toggle & Expanded Player -->
        <div id="musicPlayerContainer" class="music-player-container">
        <!-- Collapsed State - Pill Button -->
        <button id="musicPlayerToggle" class="music-player-pill" aria-label="Open music player">
          <i class="fas fa-play"></i>
          <span>Music</span>
        </button>

        <!-- Expanded State - Music Player -->
        <div id="musicPlayerExpanded" class="music-player-expanded" style="display: none;">
          <!-- Hidden Audio Element -->
          <audio id="audioPlayer" preload="metadata"></audio>

          <div class="music-player-body">
            <!-- Track Info -->
            <div class="music-track-info">
              <div class="track-title" id="currentTrackTitle">No track selected</div>
              <div class="track-time">
                <span id="currentTime">0:00</span>
                <span> / </span>
                <span id="totalTime">0:00</span>
              </div>
            </div>

            <div class="music-controls-row">
              <!-- Controls -->
              <div class="music-controls">
                <button class="control-btn" id="prevBtn" aria-label="Previous track">
                  <i class="fas fa-backward"></i>
                </button>
                <button class="control-btn control-btn-play" id="playPauseBtn" aria-label="Play/Pause">
                  <i class="fas fa-play"></i>
                </button>
                <button class="control-btn" id="nextBtn" aria-label="Next track">
                  <i class="fas fa-forward"></i>
                </button>
              </div>

              <!-- Progress Bar -->
              <div class="music-progress" id="progressContainer">
                <div class="progress-bar">
                  <div class="progress-fill" id="progressFill" style="width: 0%;"></div>
                </div>
              </div>

              <!-- Volume Control -->
              <div class="volume-control">
                <i class="fas fa-volume-up volume-icon" id="volumeIcon"></i>
                <div class="volume-slider" id="volumeContainer">
                  <div class="volume-fill" id="volumeFill" style="width: 70%;"></div>
                </div>
              </div>

              <!-- Close Button -->
              <button id="musicPlayerClose" class="music-player-close-btn" aria-label="Close music player">
                <i class="fas fa-times"></i>
              </button>
            </div>

            <!-- Playlist -->
            <div class="music-playlist">
              <div class="playlist-header">
                <h4>Playlist</h4>
                <button class="refresh-playlist-btn" id="refreshPlaylist" aria-label="Refresh playlist">
                  <i class="fas fa-sync-alt"></i>
                </button>
              </div>
              <div class="playlist-items" id="playlistItems">
                <div class="playlist-loading">
                  <i class="fas fa-spinner fa-spin"></i> Loading music...
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

    </div>
  </div>
</div>

<!-- DEN Styles -->
<style>
  /* Prevent text selection on interactive elements */
  button,
  .den-timer-card,
  .den-settings-card,
  .den-stats-card,
  .music-controls button,
  .playlist-item,
  #moreOptionsBtn,
  #optToggleCompact,
  #optToggleSettings,
  #optToggleStats,
  #optToggleAmbient,
  i.fas,
  i.far {
    user-select: none;
    -webkit-user-select: none;
    -moz-user-select: none;
    -ms-user-select: none;
  }

  /* Ensure icons don't capture pointer events */
  button i.fas,
  button i.far {
    pointer-events: none;
  }

  /* Dark mode support for DEN cards and text */
  [data-theme="dark"] .den-timer-card,
  [data-theme="dark"] .den-settings-card,
  [data-theme="dark"] .den-stats-card {
    background: var(--bg-secondary);
    border-color: var(--border-color);
  }

  /* Dark mode for all text elements */
  [data-theme="dark"] #timerDisplay,
  [data-theme="dark"] #completedSessions,
  [data-theme="dark"] #currentSession,
  [data-theme="dark"] #todaysSessions,
  [data-theme="dark"] #todaysTime,
  [data-theme="dark"] #streak,
  [data-theme="dark"] .text-black {
    color: #c2c0b6 !important;
  }

  [data-theme="dark"] .text-gray-600,
  [data-theme="dark"] .text-gray-500,
  [data-theme="dark"] .text-gray-700 {
    color: #c2c0b6 !important;
  }

  [data-theme="dark"] #sessionType {
    color: #c2c0b6 !important;
  }

  /* Dark mode for buttons */
  [data-theme="dark"] #startPauseBtn {
    background: #c2c0b6;
    border-color: #c2c0b6;
    color: #141413;
  }

  [data-theme="dark"] #startPauseBtn:hover {
    background: transparent;
    border-color: #c2c0b6;
    color: #c2c0b6;
  }

  /* Dark mode for progress bar */
  [data-theme="dark"] #progressBar {
    background: #c2c0b6;
  }

  [data-theme="dark"] .bg-gray-200 {
    background: rgba(194, 192, 182, 0.2);
  }

  [data-theme="dark"] .bg-gray-300 {
    background: rgba(194, 192, 182, 0.3);
  }

  /* Dark mode for menu items in options */
  [data-theme="dark"] #optToggleCompact,
  [data-theme="dark"] #optToggleSettings,
  [data-theme="dark"] #optToggleStats,
  [data-theme="dark"] #optToggleAmbient {
    color: #c2c0b6;
  }

  [data-theme="dark"] #optToggleCompact:hover,
  [data-theme="dark"] #optToggleSettings:hover,
  [data-theme="dark"] #optToggleStats:hover,
  [data-theme="dark"] #optToggleAmbient:hover {
    background: rgba(194, 192, 182, 0.1);
  }

  /* Dark mode for dropdown menu */
  [data-theme="dark"] #moreOptionsMenu {
    background: rgba(20, 20, 19, 0.95);
    border-color: var(--border-color);
  }

  [data-theme="dark"] #moreOptionsMenu hr {
    border-color: var(--border-color);
  }

  [data-theme="dark"] #optOpenSky,
  [data-theme="dark"] #optResetToday {
    color: #c2c0b6;
  }

  [data-theme="dark"] #optOpenSky:hover {
    background: rgba(194, 192, 182, 0.1);
  }

  [data-theme="dark"] #optResetToday {
    color: #ef4444;
  }

  [data-theme="dark"] #optResetToday:hover {
    background: rgba(239, 68, 68, 0.1);
  }

  /* Dark mode for secondary buttons */
  [data-theme="dark"] .secondary-btn,
  [data-theme="dark"] #resetBtn,
  [data-theme="dark"] #skipBtn {
    background: transparent;
    border-color: var(--border-color);
    color: #c2c0b6;
  }

  [data-theme="dark"] .secondary-btn:hover,
  [data-theme="dark"] #resetBtn:hover,
  [data-theme="dark"] #skipBtn:hover {
    background: rgba(194, 192, 182, 0.1);
    border-color: #c2c0b6;
  }

  /* Dark mode for more options button */
  [data-theme="dark"] #moreOptionsBtn {
    background: var(--bg-tertiary);
    border-color: var(--border-color);
    color: #c2c0b6;
  }

  [data-theme="dark"] #moreOptionsBtn:hover {
    background: var(--bg-primary);
  }

  /* Dark mode for settings card adjustment buttons */
  [data-theme="dark"] .bg-gray-100 {
    background: var(--bg-tertiary);
    color: #c2c0b6;
  }

  [data-theme="dark"] .bg-gray-100:hover,
  [data-theme="dark"] .hover\:bg-gray-200:hover {
    background: var(--bg-primary);
  }

  [data-theme="dark"] .bg-gray-300 {
    background: rgba(194, 192, 182, 0.3);
  }

  /* Dark mode for toggle switches */
  [data-theme="dark"] #autoStartToggle:checked + span,
  [data-theme="dark"] #soundToggle:checked + span,
  [data-theme="dark"] #notifToggle:checked + span {
    background: #c2c0b6;
  }

  [data-theme="dark"] #autoStartKnob,
  [data-theme="dark"] #soundKnob,
  [data-theme="dark"] #notifKnob {
    background: var(--bg-secondary);
  }

  /* Ambient Mode - Enhanced Glass Effect (Light Mode) */
  .ambient-glass-mode {
    position: relative;
  }

  .ambient-glass-mode .den-timer-card,
  .ambient-glass-mode .den-settings-card,
  .ambient-glass-mode .den-stats-card,
  .ambient-glass-mode #musicPlayerExpanded,
  .ambient-glass-mode #musicPlayerToggle {
    background: rgba(255, 255, 255, 0.65) !important;
    backdrop-filter: blur(20px) saturate(200%) !important;
    border: 1px solid rgba(255, 255, 255, 0.4) !important;
    box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.15),
                inset 0 1px 0 0 rgba(255, 255, 255, 0.6) !important;
  }

  /* Ambient Mode in Dark Mode - Use Dark Glass Effect */
  [data-theme="dark"] .ambient-glass-mode .den-timer-card,
  [data-theme="dark"] .ambient-glass-mode .den-settings-card,
  [data-theme="dark"] .ambient-glass-mode .den-stats-card,
  [data-theme="dark"] .ambient-glass-mode #musicPlayerExpanded,
  [data-theme="dark"] .ambient-glass-mode #musicPlayerToggle {
    background: rgba(30, 30, 35, 0.65) !important;
    backdrop-filter: blur(20px) saturate(200%) !important;
    border: 1px solid rgba(255, 255, 255, 0.1) !important;
    box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.4),
                inset 0 1px 0 0 rgba(255, 255, 255, 0.1) !important;
  }

  /* Enhance progress bars visibility in ambient mode */
  .ambient-glass-mode #progressBar,
  .ambient-glass-mode .progress-fill,
  .ambient-glass-mode .volume-fill {
    opacity: 1 !important;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
  }

  [data-theme="dark"] .ambient-glass-mode #progressBar,
  [data-theme="dark"] .ambient-glass-mode .progress-fill,
  [data-theme="dark"] .ambient-glass-mode .volume-fill {
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.5);
  }

  /* Enhance button visibility in ambient mode */
  .ambient-glass-mode .control-btn-play,
  .ambient-glass-mode #startPauseBtn {
    box-shadow: 0 4px 16px rgba(0, 0, 0, 0.25) !important;
  }

  /* Enhance text readability in ambient mode - Light Mode */
  .ambient-glass-mode h1,
  .ambient-glass-mode h2,
  .ambient-glass-mode h3,
  .ambient-glass-mode p,
  .ambient-glass-mode span,
  .ambient-glass-mode .text-black,
  .ambient-glass-mode #timerDisplay {
    text-shadow: 0 1px 4px rgba(255, 255, 255, 1), 0 0 8px rgba(255, 255, 255, 0.5);
    position: relative;
  }

  /* Enhance text readability in ambient mode - Dark Mode */
  [data-theme="dark"] .ambient-glass-mode h1,
  [data-theme="dark"] .ambient-glass-mode h2,
  [data-theme="dark"] .ambient-glass-mode h3,
  [data-theme="dark"] .ambient-glass-mode p,
  [data-theme="dark"] .ambient-glass-mode span,
  [data-theme="dark"] .ambient-glass-mode #timerDisplay {
    text-shadow: 0 1px 4px rgba(0, 0, 0, 0.8), 0 0 8px rgba(0, 0, 0, 0.4);
    color: var(--text-primary) !important;
  }

  /* Enhance icon visibility - Light Mode */
  .ambient-glass-mode i {
    filter: drop-shadow(0 1px 2px rgba(255, 255, 255, 0.8));
  }

  /* Enhance icon visibility - Dark Mode */
  [data-theme="dark"] .ambient-glass-mode i {
    filter: drop-shadow(0 1px 2px rgba(0, 0, 0, 0.8));
  }

  /* Music Player Styles */
  .music-player-container {
    width: 100%;
    margin-top: 1.5rem;
    margin-bottom: 2rem;
    display: flex;
    justify-content: center;
    position: relative;
  }

  /* Pill Button (Collapsed State) */
  .music-player-pill {
  margin-bottom: 8.5rem;
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.75rem 1.5rem;
    background: white;
    border: 2px solid #e5e7eb;
    border-radius: 50px;
    cursor: pointer;
    transition: all 0.3s ease;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    font-family: 'Space Grotesk', sans-serif;
    font-size: 0.875rem;
    font-weight: 500;
    color: #6b7280;
    outline: none;
  }

  .music-player-pill:hover {
    background: #f9fafb;
    border-color: #9ca3af;
    transform: translateY(-2px);
    box-shadow: 0 6px 16px rgba(0, 0, 0, 0.15);
  }

  .music-player-pill i {
    font-size: 0.875rem;
    color: #8b5cf6;
  }

  .music-player-pill span {
    color: #374151;
  }

  /* Expanded Music Player */
  .music-player-expanded {
    width: 100%;
    background: white;
    border-radius: 16px;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    border: 1px solid #e5e7eb;
    overflow: hidden;
    animation: expandPlayer 0.3s ease;
  }

  @keyframes expandPlayer {
    from {
      opacity: 0;
      transform: scaleX(0.95) translateY(10px);
    }
    to {
      opacity: 1;
      transform: scaleX(1) translateY(0);
    }
  }

  /* Body */
  .music-player-body {
    padding: 1rem 1.5rem;
    display: flex;
    flex-direction: column;
    gap: 1rem;
    flex: 1;
    overflow: hidden;
  }

  /* Track Info */
  .music-track-info {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding-bottom: 0.5rem;
    border-bottom: 1px solid #e5e7eb;
  }

  .track-title {
    font-size: 0.875rem;
    font-weight: 600;
    color: #374151;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    max-width: 60%;
  }

  .track-time {
    font-size: 0.75rem;
    color: #6b7280;
    white-space: nowrap;
  }

  /* Progress Bar */
  .music-progress {
    flex: 1;
    max-width: 400px;
  }

  .progress-bar {
    width: 100%;
    height: 4px;
    background: #e5e7eb;
    border-radius: 2px;
    overflow: visible;
    cursor: pointer;
    position: relative;
  }

  .progress-fill {
    height: 100%;
    background: #8b5cf6;
    border-radius: 2px;
    transition: width 0.1s linear;
    position: relative;
    box-shadow: 0 0 10px rgba(139, 92, 246, 0.4);
  }

  /* Waveform animation when playing */
  .progress-fill.playing::after {
    content: '';
    position: absolute;
    top: -2px;
    right: 0;
    width: 3px;
    height: calc(100% + 4px);
    background: #8b5cf6;
    border-radius: 2px;
    box-shadow: 0 0 12px rgba(139, 92, 246, 0.8),
                0 0 20px rgba(139, 92, 246, 0.4);
    animation: waveform 0.8s ease-in-out infinite;
  }

  @keyframes waveform {
    0%, 100% {
      transform: scaleY(1);
      opacity: 0.8;
    }
    25% {
      transform: scaleY(1.3);
      opacity: 1;
    }
    50% {
      transform: scaleY(0.8);
      opacity: 0.9;
    }
    75% {
      transform: scaleY(1.5);
      opacity: 1;
    }
  }

  /* Controls Row */
  .music-controls-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: 1.5rem;
  }

  /* Controls */
  .music-controls {
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 1rem;
  }

  .control-btn {
    width: 36px;
    height: 36px;
    border-radius: 50%;
    background: #f3f4f6;
    border: none;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: all 0.2s;
    color: #374151;
  }

  .control-btn:hover {
    background: #e5e7eb;
    transform: scale(1.05);
  }

  .control-btn-play {
    width: 40px;
    height: 40px;
    background: #000000;
    color: white;
  }

  .control-btn-play:hover {
    background: #1f2937;
  }

  .control-btn i {
    font-size: 0.75rem;
  }

  .control-btn-play i {
    font-size: 0.875rem;
  }

  /* Volume Control */
  .volume-control {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    max-width: 150px;
  }

  .volume-icon {
    color: #6b7280;
    font-size: 0.75rem;
    flex-shrink: 0;
  }

  .volume-slider {
    flex: 1;
    height: 6px;
    background: #e5e7eb;
    border-radius: 3px;
    position: relative;
    cursor: pointer;
    box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.1);
  }

  .volume-fill {
    height: 100%;
    background: #8b5cf6;
    border-radius: 3px;
    pointer-events: none;
    box-shadow: 0 0 8px rgba(139, 92, 246, 0.4);
  }

  /* Close Button */
  .music-player-close-btn {
    width: 28px;
    height: 28px;
    border-radius: 50%;
    background: #f3f4f6;
    border: none;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: all 0.2s;
    color: #6b7280;
    font-size: 0.75rem;
    flex-shrink: 0;
  }

  .music-player-close-btn:hover {
    background: #e5e7eb;
    color: #374151;
  }

  /* Playlist Styles */
  .music-playlist {
    flex: 1;
    display: flex;
    flex-direction: column;
    overflow: hidden;
    border-top: 1px solid #e5e7eb;
    padding-top: 1rem;
  }

  .playlist-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 0.75rem;
  }

  .playlist-header h4 {
    font-size: 0.875rem;
    font-weight: 600;
    color: #374151;
    margin: 0;
  }

  .refresh-playlist-btn {
    width: 24px;
    height: 24px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: transparent;
    border: none;
    border-radius: 4px;
    color: #6b7280;
    cursor: pointer;
    transition: all 0.2s ease;
  }

  .refresh-playlist-btn:hover {
    background: #f3f4f6;
    color: #374151;
  }

  .refresh-playlist-btn i {
    font-size: 0.75rem;
  }

  .playlist-items {
    flex: 1;
    overflow-y: auto;
    display: flex;
    flex-direction: column;
    gap: 0.25rem;
  }

  .playlist-item {
    padding: 0.5rem 0.75rem;
    background: #f9fafb;
    border-radius: 0.5rem;
    cursor: pointer;
    transition: all 0.2s ease;
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }

  .playlist-item:hover {
    background: #f3f4f6;
  }

  .playlist-item.active {
    background: #8b5cf6;
    color: white;
  }

  .playlist-item-icon {
    width: 24px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 0.75rem;
    color: #6b7280;
  }

  .playlist-item.active .playlist-item-icon {
    color: white;
  }

  .playlist-item-title {
    flex: 1;
    font-size: 0.8125rem;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    color: #374151;
  }

  .playlist-item.active .playlist-item-title {
    color: white;
    font-weight: 500;
  }

  .playlist-loading,
  .playlist-empty {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: 2rem 1rem;
    color: #6b7280;
    font-size: 0.875rem;
    gap: 0.5rem;
  }

  .playlist-empty i {
    font-size: 2rem;
    opacity: 0.3;
  }

  /* Dark Mode Support */
  [data-theme="dark"] .music-player-pill {
    background: var(--bg-secondary);
    border-color: var(--border-color);
  }

  [data-theme="dark"] .music-player-pill:hover {
    background: var(--bg-tertiary);
  }

  [data-theme="dark"] .music-player-pill span {
    color: var(--text-primary);
  }

  [data-theme="dark"] .music-player-expanded {
    background: var(--bg-secondary);
    border-color: var(--border-color);
  }

  [data-theme="dark"] .music-track-info {
    border-color: var(--border-color);
  }

  [data-theme="dark"] .track-title {
    color: var(--text-primary);
  }

  [data-theme="dark"] .track-time {
    color: var(--text-secondary);
  }

  /* Styled scrollbar for playlist items */
  .playlist-items::-webkit-scrollbar {
    width: 8px;
  }

  .playlist-items::-webkit-scrollbar-track {
    background: transparent;
    margin: 8px 0;
  }

  .playlist-items::-webkit-scrollbar-thumb {
    background: #cbd5e1;
    border-radius: 10px;
    border: 2px solid transparent;
    background-clip: content-box;
  }

  .playlist-items::-webkit-scrollbar-thumb:hover {
    background: #94a3b8;
    background-clip: content-box;
  }

  [data-theme="dark"] .playlist-items::-webkit-scrollbar-thumb {
    background: #4a5568;
  }

  [data-theme="dark"] .playlist-items::-webkit-scrollbar-thumb:hover {
    background: #718096;
  }

  /* Firefox scrollbar for playlist items */
  .playlist-items {
    scrollbar-width: thin;
    scrollbar-color: #cbd5e1 transparent;
  }

  [data-theme="dark"] .playlist-items {
    scrollbar-color: #4a5568 transparent;
  }

  [data-theme="dark"] .music-playlist {
    border-color: var(--border-color);
  }

  [data-theme="dark"] .playlist-header h4 {
    color: var(--text-primary);
  }

  [data-theme="dark"] .refresh-playlist-btn {
    color: var(--text-secondary);
  }

  [data-theme="dark"] .refresh-playlist-btn:hover {
    background: var(--bg-tertiary);
    color: var(--text-primary);
  }

  [data-theme="dark"] .playlist-item {
    background: var(--bg-tertiary);
  }

  [data-theme="dark"] .playlist-item:hover {
    background: var(--bg-primary);
  }

  [data-theme="dark"] .playlist-item-title {
    color: var(--text-primary);
  }

  [data-theme="dark"] .playlist-item-icon {
    color: var(--text-secondary);
  }

  [data-theme="dark"] .playlist-loading,
  [data-theme="dark"] .playlist-empty {
    color: var(--text-secondary);
  }

  [data-theme="dark"] .progress-bar {
    background: rgba(255, 255, 255, 0.1);
  }

  [data-theme="dark"] .progress-fill {
    background: #8b5cf6;
    box-shadow: 0 0 10px rgba(139, 92, 246, 0.6);
  }

  [data-theme="dark"] .volume-slider {
    background: rgba(255, 255, 255, 0.1);
    box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.3);
  }

  [data-theme="dark"] .volume-fill {
    background: #8b5cf6;
    box-shadow: 0 0 8px rgba(139, 92, 246, 0.5);
  }

  /* Waveform animation in dark mode */
  [data-theme="dark"] .progress-fill.playing::after {
    background: #a78bfa;
    box-shadow: 0 0 12px rgba(167, 139, 250, 0.9),
                0 0 20px rgba(167, 139, 250, 0.5);
  }

  [data-theme="dark"] .control-btn {
    background: var(--bg-tertiary);
    border-color: var(--border-color);
    color: var(--text-primary);
  }

  [data-theme="dark"] .control-btn:hover {
    background: var(--bg-primary);
  }

  [data-theme="dark"] .music-player-close-btn {
    background: var(--bg-tertiary);
    color: var(--text-secondary);
  }

  [data-theme="dark"] .music-player-close-btn:hover {
    background: var(--bg-primary);
  }

  [data-theme="dark"] .progress-bar,
  [data-theme="dark"] .volume-slider {
    background: var(--bg-tertiary);
  }

  [data-theme="dark"] .volume-icon {
    color: var(--text-secondary);
  }

  /* Responsive */
  @media (max-width: 768px) {
    .music-controls-row {
      flex-wrap: wrap;
      gap: 1rem;
      justify-content: center;
    }

    .music-progress {
      order: -1;
      width: 100%;
      max-width: 100%;
    }

    .volume-control {
      max-width: 100%;
      width: 100%;
    }
  }

  /* Compact layout helpers */
  body.compact .card-padding {
    padding: 12px 16px !important;
  }
  body.compact #timerDisplay {
    font-size: 2.75rem;
    line-height: 1.1;
  }
  body.compact .section-mt {
    margin-top: 0.75rem !important;
  }
  body.compact .controls-gap {
    gap: 0.5rem !important;
  }
  body.compact .hidden-compact {
    display: none !important;
  }
  body.compact .secondary-btn {
    padding-top: 0.5rem;
    padding-bottom: 0.5rem;
  }
  /* Dropdown base */
  .dropdown-enter {
    opacity: 0;
    transform: translateY(-6px);
    pointer-events: none;
  }
  .dropdown-open {
    opacity: 1;
    transform: translateY(0);
    pointer-events: auto;
  }
</style>

<!-- DEN JavaScript -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r121/three.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/vanta@latest/dist/vanta.clouds.min.js"></script>
<script>
  // Only initialize DEN if not already initialized
  if (typeof window.denInitialized === 'undefined') {
    window.denInitialized = true;

    const STORAGE_KEYS = {
      settings: "pz_settings_v1",
      stats: "pz_stats_v1",
      ambient: "pz_ambient_v1",
      state: "pz_state_v1",
      ui: "pz_ui_v1",
    };

    const todayStr = () => {
      const d = new Date();
      return d.toISOString().slice(0, 10);
    };

    // Simple beep using WebAudio
    function beep(freq = 880, duration = 120, volume = 0.04) {
      try {
        const ctx = new (window.AudioContext || window.webkitAudioContext)();
        const o = ctx.createOscillator();
        const g = ctx.createGain();
        o.type = "sine";
        o.frequency.value = freq;
        g.gain.value = volume;
        o.connect(g);
        g.connect(ctx.destination);
        o.start();
        setTimeout(() => {
          o.stop();
          ctx.close();
        }, duration);
      } catch {}
    }

    async function ensureNotificationPermission() {
      if (!("Notification" in window)) return false;
      if (Notification.permission === "granted") return true;
      if (Notification.permission !== "denied") {
        try {
          const res = await Notification.requestPermission();
          return res === "granted";
        } catch {
          return false;
        }
      }
      return false;
    }

    function notify(title, body) {
      if (!("Notification" in window)) return;
      if (Notification.permission === "granted") {
        new Notification(title, { body });
      }
    }

    class PomodoroTimer {
      constructor() {
        this.isRunning = false;
        this.currentSession = "work";
        this.sessionCount = 0;
        this.completedSessions = 0;
        this.currentSessionNumber = 1;

        this.settings = {
          work: 25,
          break: 5,
          longBreak: 15,
          autoStart: false,
          sound: false,
          notifications: false,
        };

        this.timeLeft = this.settings.work * 60;
        this.totalTime = this.settings.work * 60;
        this.timer = null;
        this.endTimestamp = null;

        this.initializeElements();
        this.loadFromStorage();
        this.updateDisplay();
        this.attachEventListeners();
        this.attachKeyboardShortcuts();
        window.addEventListener("beforeunload", () => this.persistState());
      }

      initializeElements() {
        this.timerDisplay = document.getElementById("timerDisplay");
        this.startPauseBtn = document.getElementById("startPauseBtn");
        this.resetBtn = document.getElementById("resetBtn");
        this.skipBtn = document.getElementById("skipBtn");
        this.progressBar = document.getElementById("progressBar");
        this.progressText = document.getElementById("progressText");
        this.sessionType = document.getElementById("sessionType");
        this.completedSessionsEl = document.getElementById("completedSessions");
        this.currentSessionEl = document.getElementById("currentSession");
        this.workDurationEl = document.getElementById("workDuration");
        this.breakDurationEl = document.getElementById("breakDuration");
        this.longBreakDurationEl = document.getElementById("longBreakDuration");
        this.todaysSessionsEl = document.getElementById("todaysSessions");
        this.todaysTimeEl = document.getElementById("todaysTime");
        this.streakEl = document.getElementById("streak");
        this.autoStartToggle = document.getElementById("autoStartToggle");
        this.soundToggle = document.getElementById("soundToggle");
        this.notifToggle = document.getElementById("notifToggle");
        this.autoStartKnob = document.getElementById("autoStartKnob");
        this.soundKnob = document.getElementById("soundKnob");
        this.notifKnob = document.getElementById("notifKnob");
      }

      attachEventListeners() {
        this.startPauseBtn.addEventListener("click", () => this.toggleTimer());
        this.resetBtn.addEventListener("click", () => this.resetTimer());
        this.skipBtn.addEventListener("click", () => this.skipSession());

        this.autoStartToggle.addEventListener("change", () => {
          this.settings.autoStart = this.autoStartToggle.checked;
          this.updateToggleUI();
          this.persistSettings();
        });
        this.soundToggle.addEventListener("change", () => {
          this.settings.sound = this.soundToggle.checked;
          this.updateToggleUI();
          this.persistSettings();
          if (this.settings.sound) beep(880, 80);
        });
        this.notifToggle.addEventListener("change", async () => {
          this.settings.notifications = this.notifToggle.checked;
          if (this.settings.notifications) {
            const ok = await ensureNotificationPermission();
            if (!ok) {
              this.settings.notifications = false;
              this.notifToggle.checked = false;
            }
          }
          this.updateToggleUI();
          this.persistSettings();
        });
      }

      attachKeyboardShortcuts() {
        window.addEventListener("keydown", (e) => {
          const activeElement = document.activeElement;
          const tag = activeElement?.tagName?.toLowerCase();

          // Ignore shortcuts when typing in input fields, textareas, or contentEditable elements (like Quill editor)
          if (
            tag === "input" ||
            tag === "textarea" ||
            activeElement?.isContentEditable ||
            activeElement?.classList?.contains('ql-editor') ||
            activeElement?.closest('.ql-editor')
          ) return;

          if (e.code === "Space") {
            e.preventDefault();
            this.toggleTimer();
          } else if (e.key === "r" || e.key === "R") {
            e.preventDefault();
            this.resetTimer();
          } else if (e.key === "s" || e.key === "S") {
            e.preventDefault();
            this.skipSession();
          } else if (e.key === "a" || e.key === "A") {
            e.preventDefault();
            if (window.ambientMode) window.ambientMode.toggle();
          }
        });
      }

      loadFromStorage() {
        try {
          const saved = JSON.parse(localStorage.getItem(STORAGE_KEYS.settings) || "{}");
          Object.assign(this.settings, saved);
        } catch {}

        let stats = { date: todayStr(), sessions: 0, streak: 0 };
        try {
          const saved = JSON.parse(localStorage.getItem(STORAGE_KEYS.stats) || "{}");
          if (saved.date && saved.date !== todayStr()) {
            const prev = new Date(saved.date);
            const today = new Date(todayStr());
            const diffDays = Math.round((today - prev) / 86400000);
            if (diffDays === 1 && (saved.sessions || 0) > 0) {
              stats.streak = (saved.streak || 0) + 1;
            } else {
              stats.streak = 0;
            }
            stats.sessions = 0;
            stats.date = todayStr();
          } else if (saved.date === todayStr()) {
            stats = {
              date: saved.date,
              sessions: saved.sessions || 0,
              streak: saved.streak || 0,
            };
          }
        } catch {}
        this.completedSessions = stats.sessions || 0;
        this.streakEl.textContent = stats.streak || 0;
        this.todaysSessionsEl.textContent = this.completedSessions;

        try {
          const state = JSON.parse(localStorage.getItem(STORAGE_KEYS.state) || "{}");
          if (state && state.currentSession && Number.isInteger(state.timeLeft)) {
            this.currentSession = state.currentSession;
            this.timeLeft = Math.max(0, state.timeLeft);
            this.totalTime = Math.max(1, state.totalTime || this.timeLeft || 1);
            this.sessionCount = state.sessionCount || 0;
            this.currentSessionNumber = state.currentSessionNumber || 1;
          }
        } catch {}

        this.autoStartToggle.checked = !!this.settings.autoStart;
        this.soundToggle.checked = !!this.settings.sound;
        this.notifToggle.checked = !!this.settings.notifications;
        this.updateToggleUI();
      }

      persistSettings() {
        localStorage.setItem(STORAGE_KEYS.settings, JSON.stringify(this.settings));
      }

      persistStats() {
        const existing = JSON.parse(localStorage.getItem(STORAGE_KEYS.stats) || "{}");
        const toSave = {
          date: todayStr(),
          sessions: this.completedSessions,
          streak: this.streakEl.textContent ? parseInt(this.streakEl.textContent) : existing.streak || 0,
        };
        localStorage.setItem(STORAGE_KEYS.stats, JSON.stringify(toSave));
      }

      persistState() {
        const state = {
          currentSession: this.currentSession,
          timeLeft: this.timeLeft,
          totalTime: this.totalTime,
          sessionCount: this.sessionCount,
          currentSessionNumber: this.currentSessionNumber,
        };
        localStorage.setItem(STORAGE_KEYS.state, JSON.stringify(state));
      }

      updateToggleUI() {
        const setToggle = (inputEl, knobEl) => {
          if (inputEl.checked) {
            knobEl.style.transform = "translateX(16px)";
            inputEl.nextElementSibling.classList.remove("bg-gray-300");
            inputEl.nextElementSibling.classList.add("bg-purple-600");
          } else {
            knobEl.style.transform = "translateX(0)";
            inputEl.nextElementSibling.classList.add("bg-gray-300");
            inputEl.nextElementSibling.classList.remove("bg-purple-600");
          }
        };
        setToggle(this.autoStartToggle, this.autoStartKnob);
        setToggle(this.soundToggle, this.soundKnob);
        setToggle(this.notifToggle, this.notifKnob);
      }

      setButtonState(kind) {
        this.startPauseBtn.classList.remove(
          "bg-black", "border-black", "hover:bg-transparent", "hover:border-black", "hover:text-black",
          "bg-purple-600", "border-purple-600", "hover:bg-purple-700", "hover:border-purple-700", "text-white"
        );
        if (kind === "start") {
          this.startPauseBtn.innerHTML = "<span>Start Focus</span>";
          this.startPauseBtn.classList.add("bg-black", "border-black", "hover:bg-transparent", "hover:border-black", "hover:text-black", "text-white");
        } else if (kind === "pause") {
          this.startPauseBtn.innerHTML = "<span>Pause</span>";
          this.startPauseBtn.classList.add("bg-purple-600", "border-purple-600", "hover:bg-purple-700", "hover:border-purple-700", "text-white");
        } else {
          this.startPauseBtn.innerHTML = "<span>Resume</span>";
          this.startPauseBtn.classList.add("bg-black", "border-black", "hover:bg-transparent", "hover:border-black", "hover:text-black", "text-white");
        }
      }

      toggleTimer() {
        if (this.isRunning) {
          this.pauseTimer();
        } else {
          this.startTimer();
        }
      }

      startTimer() {
        if (this.isRunning) return;
        this.isRunning = true;
        this.setButtonState("pause");
        const now = Date.now();
        this.endTimestamp = now + this.timeLeft * 1000;

        if (this.timer) clearInterval(this.timer);
        this.timer = setInterval(() => {
          const remainingMs = this.endTimestamp - Date.now();
          const nextLeft = Math.max(0, Math.ceil(remainingMs / 1000));
          if (nextLeft !== this.timeLeft) {
            this.timeLeft = nextLeft;
            this.updateDisplay();
          } else {
            this.updateDisplay(true);
          }
          if (remainingMs <= 0) {
            this.completeSession();
          }
        }, 250);
      }

      pauseTimer() {
        if (!this.isRunning) return;
        this.isRunning = false;
        const remainingMs = (this.endTimestamp || Date.now()) - Date.now();
        this.timeLeft = Math.max(0, Math.ceil(remainingMs / 1000));
        clearInterval(this.timer);
        this.timer = null;
        this.setButtonState("resume");
        this.persistState();
      }

      resetTimer() {
        this.isRunning = false;
        clearInterval(this.timer);
        this.timer = null;
        this.endTimestamp = null;

        if (this.currentSession === "work") {
          this.timeLeft = this.settings.work * 60;
          this.totalTime = this.settings.work * 60;
        } else if (this.currentSession === "shortBreak") {
          this.timeLeft = this.settings.break * 60;
          this.totalTime = this.settings.break * 60;
        } else {
          this.timeLeft = this.settings.longBreak * 60;
          this.totalTime = this.settings.longBreak * 60;
        }

        this.setButtonState("start");
        this.updateDisplay();
        this.persistState();
      }

      skipSession() {
        this.completeSession(true);
      }

      maybeNotify(title, body) {
        if (this.settings.sound) {
          beep(1046, 80);
          setTimeout(() => beep(880, 80), 120);
          setTimeout(() => beep(659, 120), 260);
        }
        if (this.settings.notifications) {
          notify(title, body);
        }
      }

      completeSession(skipped = false) {
        this.isRunning = false;
        clearInterval(this.timer);
        this.timer = null;
        this.endTimestamp = null;

        let justCompletedWork = false;

        if (this.currentSession === "work") {
          justCompletedWork = true;
          this.completedSessions++;
          this.sessionCount++;

          if (this.sessionCount % 4 === 0) {
            this.currentSession = "longBreak";
            this.timeLeft = this.settings.longBreak * 60;
            this.totalTime = this.settings.longBreak * 60;
          } else {
            this.currentSession = "shortBreak";
            this.timeLeft = this.settings.break * 60;
            this.totalTime = this.settings.break * 60;
          }
        } else {
          this.currentSession = "work";
          this.timeLeft = this.settings.work * 60;
          this.totalTime = this.settings.work * 60;
          this.currentSessionNumber++;
        }

        if (!skipped) {
          if (justCompletedWork) {
            this.maybeNotify("Work complete", "Break started. Nice job!");
          } else {
            this.maybeNotify("Break over", "Back to focus.");
          }
        }

        this.setButtonState(this.settings.autoStart ? "pause" : "start");
        this.updateDisplay();
        this.updateStats();
        this.persistState();

        if (this.settings.autoStart) {
          this.startTimer();
        }
      }

      updateDisplay(smooth = false) {
        const minutes = Math.floor(this.timeLeft / 60);
        const seconds = this.timeLeft % 60;
        const label = this.currentSession === "work" ? "Focus" :
                      this.currentSession === "shortBreak" ? "Short Break" : "Long Break";

        this.timerDisplay.textContent = `${minutes.toString().padStart(2, "0")}:${seconds.toString().padStart(2, "0")}`;
        document.title = `${this.timerDisplay.textContent} • ${label} – DEN`;

        const rawProgress = ((this.totalTime - this.timeLeft) / Math.max(1, this.totalTime)) * 100;
        this.progressBar.style.width = `${Math.min(100, Math.max(0, rawProgress))}%`;
        this.progressText.textContent = `${Math.round(rawProgress)}%`;

        if (window.ambientMode && (this.isRunning || smooth)) {
          window.ambientMode.updateDynamicColor(
            Math.min(1, Math.max(0, (this.totalTime - this.timeLeft) / Math.max(1, this.totalTime)))
          );
        }

        this.completedSessionsEl.textContent = this.completedSessions;
        this.currentSessionEl.textContent = this.currentSessionNumber;

        if (this.currentSession === "work") {
          this.sessionType.textContent = "Work Session • Stay Focused";
          this.progressBar.classList.remove("bg-purple-600");
          this.progressBar.classList.add("bg-black");
        } else if (this.currentSession === "shortBreak") {
          this.sessionType.textContent = "Short Break • Relax & Recharge";
          this.progressBar.classList.remove("bg-black");
          this.progressBar.classList.add("bg-purple-600");
        } else {
          this.sessionType.textContent = "Long Break • Take Your Time";
          this.progressBar.classList.remove("bg-black");
          this.progressBar.classList.add("bg-purple-600");
        }

        this.workDurationEl.textContent = this.settings.work;
        this.breakDurationEl.textContent = this.settings.break;
        this.longBreakDurationEl.textContent = this.settings.longBreak;
      }

      updateStats() {
        this.todaysSessionsEl.textContent = this.completedSessions;
        const focusTimeHours = Math.round(((this.completedSessions * this.settings.work) / 60) * 10) / 10;
        this.todaysTimeEl.textContent = `${focusTimeHours}h`;

        try {
          const saved = JSON.parse(localStorage.getItem(STORAGE_KEYS.stats) || "{}");
          let streak = saved?.streak || 0;
          this.streakEl.textContent = streak;
        } catch {}
        this.persistStats();
      }
    }

    window.adjustTime = function(type, minutes) {
      if (window.pomodoroTimer.isRunning) return;

      if (type === "work") {
        window.pomodoroTimer.settings.work = Math.max(5, Math.min(120, window.pomodoroTimer.settings.work + minutes));
        if (window.pomodoroTimer.currentSession === "work") {
          window.pomodoroTimer.timeLeft = window.pomodoroTimer.settings.work * 60;
          window.pomodoroTimer.totalTime = window.pomodoroTimer.settings.work * 60;
        }
      } else if (type === "break") {
        window.pomodoroTimer.settings.break = Math.max(1, Math.min(60, window.pomodoroTimer.settings.break + minutes));
        if (window.pomodoroTimer.currentSession === "shortBreak") {
          window.pomodoroTimer.timeLeft = window.pomodoroTimer.settings.break * 60;
          window.pomodoroTimer.totalTime = window.pomodoroTimer.settings.break * 60;
        }
      } else if (type === "longBreak") {
        window.pomodoroTimer.settings.longBreak = Math.max(5, Math.min(120, window.pomodoroTimer.settings.longBreak + minutes));
        if (window.pomodoroTimer.currentSession === "longBreak") {
          window.pomodoroTimer.timeLeft = window.pomodoroTimer.settings.longBreak * 60;
          window.pomodoroTimer.totalTime = window.pomodoroTimer.settings.longBreak * 60;
        }
      }

      window.pomodoroTimer.persistSettings();
      window.pomodoroTimer.updateDisplay();
    };

    class AmbientMode {
      constructor() {
        console.log('🌌 AmbientMode constructor called');

        this.isActive = false;
        this.vantaEffect = null;

        console.log('🔍 Looking for ambientToggle element...');
        this.toggleBtn = document.getElementById("ambientToggle");
        console.log('🔍 ambientToggle found:', this.toggleBtn);

        if (this.toggleBtn) {
          console.log('✅ Toggle button exists in DOM');

          // CRITICAL: Remove any inline styles and set initial data-visible state
          this.toggleBtn.removeAttribute('style');
          this.toggleBtn.setAttribute('data-visible', 'false'); // Will be set to true by navigation script when on DEN section

          const styles = window.getComputedStyle(this.toggleBtn);
          console.log('🎨 Initial toggle styles:', {
            display: styles.display,
            visibility: styles.visibility,
            opacity: styles.opacity,
            position: styles.position,
            top: styles.top,
            right: styles.right,
            zIndex: styles.zIndex
          });
        } else {
          console.error('❌ CRITICAL: ambientToggle NOT FOUND in DOM during AmbientMode construction!');
        }

        this.vantaBg = document.getElementById("vanta-bg");
        this.colorPickerContainer = document.getElementById("colorPickerContainer");
        this.colorPickerToggle = document.getElementById("colorPickerToggle");
        this.colorOptions = document.getElementById("colorOptions");
        this.currentColorIndicator = document.getElementById("currentColorIndicator");

        console.log('🔍 All DEN elements check:', {
          vantaBg: !!this.vantaBg,
          colorPickerContainer: !!this.colorPickerContainer,
          colorPickerToggle: !!this.colorPickerToggle,
          colorOptions: !!this.colorOptions,
          currentColorIndicator: !!this.currentColorIndicator
        });

        // CRITICAL: Initialize color picker container with data-visible
        if (this.colorPickerContainer) {
          console.log('✅ Color picker container exists, initializing...');
          this.colorPickerContainer.removeAttribute('style');
          this.colorPickerContainer.setAttribute('data-visible', 'false');
        } else {
          console.error('❌ Color picker container NOT FOUND!');
        }

        this.currentSkyColor = 0x68c7ff;
        this.colorPickerOpen = false;
        this.isDynamicMode = false;

        this.dynamicColors = [
          { progress: 0, color: 0x87ceeb, name: "Dawn" },
          { progress: 0.25, color: 0x68c7ff, name: "Morning" },
          { progress: 0.5, color: 0xffd700, name: "Noon" },
          { progress: 0.75, color: 0xff6b47, name: "Sunset" },
          { progress: 1, color: 0x2c3e50, name: "Night" },
        ];

        this.initializeToggle();
        this.initializeColorPicker();
        this.loadAmbientPrefs();
      }

      initializeToggle() {
        console.log('🎯 Initializing ambient toggle button...');
        if (!this.toggleBtn) {
          console.error('❌ Cannot initialize toggle - button is null!');
          return;
        }

        this.toggleBtn.addEventListener("click", () => {
          console.log('🖱️ Ambient toggle clicked!');
          this.toggle();
        });

        console.log('✅ Toggle button click handler attached');
      }

      initializeColorPicker() {
        this.colorPickerToggle.addEventListener("click", (e) => {
          e.stopPropagation();
          this.toggleColorPicker();
        });

        document.querySelectorAll(".color-option").forEach((option) => {
          option.addEventListener("click", (e) => {
            const colorAttr = e.currentTarget.dataset.color;
            const name = e.currentTarget.dataset.name;
            if (colorAttr === "dynamic") {
              this.changeColor("dynamic", name);
            } else {
              const color = parseInt(colorAttr);
              this.changeColor(color, name);
            }
            this.closeColorPicker();
          });
        });

        document.addEventListener("click", (e) => {
          if (!this.colorPickerContainer.contains(e.target)) {
            this.closeColorPicker();
          }
        });
      }

      toggleColorPicker() {
        const expanded = this.colorPickerToggle.getAttribute("aria-expanded") === "true";
        this.colorPickerToggle.setAttribute("aria-expanded", (!expanded).toString());
        if (this.colorPickerOpen) {
          this.closeColorPicker();
        } else {
          this.openColorPicker();
        }
      }

      openColorPicker() {
        this.colorPickerOpen = true;
        this.colorOptions.classList.remove("opacity-0", "pointer-events-none", "translate-y-[-10px]");
        this.colorOptions.classList.add("opacity-100", "pointer-events-auto", "translate-y-0");
      }

      closeColorPicker() {
        this.colorPickerOpen = false;
        this.colorOptions.classList.add("opacity-0", "pointer-events-none", "translate-y-[-10px]");
        this.colorOptions.classList.remove("opacity-100", "pointer-events-auto", "translate-y-0");
      }

      changeColor(color, colorName) {
        if (color === "dynamic") {
          this.isDynamicMode = true;
          this.persistAmbientPrefs();
          this.currentColorIndicator.className = "w-3 h-3 rounded-full bg-gradient-to-r from-blue-400 via-yellow-400 to-purple-600";
          if (this.isActive && this.vantaEffect && window.pomodoroTimer) {
            const progress = (window.pomodoroTimer.totalTime - window.pomodoroTimer.timeLeft) / Math.max(1, window.pomodoroTimer.totalTime);
            this.updateDynamicColor(progress);
          }
          return;
        } else {
          this.isDynamicMode = false;
          this.currentSkyColor = color;
          this.persistAmbientPrefs();
        }

        const colorMap = {
          0x68c7ff: "bg-blue-400",
          0xff6b6b: "bg-red-400",
          0x9b59b6: "bg-purple-400",
          0x2ecc71: "bg-green-400",
        };
        this.currentColorIndicator.className = `w-3 h-3 rounded-full ${colorMap[color] || "bg-blue-400"}`;

        if (this.isActive && this.vantaEffect) {
          this.vantaEffect.setOptions({ skyColor: color });
        }
      }

      updateDynamicColor(progress) {
        if (!this.isDynamicMode || !this.isActive || !this.vantaEffect) return;

        let targetColor = this.dynamicColors[0];

        for (let i = 0; i < this.dynamicColors.length - 1; i++) {
          const current = this.dynamicColors[i];
          const next = this.dynamicColors[i + 1];

          if (progress >= current.progress && progress <= next.progress) {
            const localProgress = (progress - current.progress) / (next.progress - current.progress);
            targetColor = this.interpolateColor(current, next, localProgress);
            break;
          }
        }

        this.vantaEffect.setOptions({ skyColor: targetColor.color });
      }

      interpolateColor(color1, color2, progress) {
        const r1 = (color1.color >> 16) & 255;
        const g1 = (color1.color >> 8) & 255;
        const b1 = color1.color & 255;

        const r2 = (color2.color >> 16) & 255;
        const g2 = (color2.color >> 8) & 255;
        const b2 = color2.color & 255;

        const r = Math.round(r1 + (r2 - r1) * progress);
        const g = Math.round(g1 + (g2 - g1) * progress);
        const b = Math.round(b1 + (b2 - b1) * progress);

        return {
          color: (r << 16) | (g << 8) | b,
          name: `${color1.name} to ${color2.name}`,
        };
      }

      toggle() {
        this.isActive = !this.isActive;

        if (this.isActive) {
          this.enableAmbientMode();
        } else {
          this.disableAmbientMode();
        }
        this.persistAmbientPrefs();
      }

      enableAmbientMode() {
        console.log('✨ Enabling ambient mode...');
        this.toggleBtn.textContent = "Ambient: On";
        this.toggleBtn.setAttribute("aria-pressed", "true");
        this.toggleBtn.classList.add("text-white", "bg-purple-600", "border-purple-600");
        this.toggleBtn.classList.remove("text-gray-600", "bg-white/80", "border-gray-200");

        // Use data-visible attribute for color picker
        this.colorPickerContainer.setAttribute('data-visible', 'true');
        this.colorPickerContainer.removeAttribute('style');

        this.vantaBg.style.opacity = "1";

        // Add glass effect class to denScrollContent
        const denContent = document.getElementById('denScrollContent');
        if (denContent) {
          denContent.classList.add('ambient-glass-mode');
        }

        // Add class to body to trigger glassmorphism on nav elements
        document.body.classList.add('ambient-active');

        if (typeof VANTA !== 'undefined' && VANTA.CLOUDS) {
          this.vantaEffect = VANTA.CLOUDS({
            el: "#vanta-bg",
            mouseControls: true,
            touchControls: true,
            gyroControls: false,
            minHeight: window.innerHeight,
            minWidth: window.innerWidth,
            skyColor: this.isDynamicMode ? 0x68c7ff : this.currentSkyColor,
            cloudColor: 0xc0c0c0,
            cloudShadowColor: 0x183550,
            sunColor: 0xff6600,
            sunGlareColor: 0xff9919,
            sunlightColor: 0xff9933,
            speed: 0.8,
            cloudOpacity: 0.8,
          });

          if (this.isDynamicMode && window.pomodoroTimer) {
            const progress = (window.pomodoroTimer.totalTime - window.pomodoroTimer.timeLeft) / Math.max(1, window.pomodoroTimer.totalTime);
            this.updateDynamicColor(progress);
          }
        }
      }

      disableAmbientMode() {
        console.log('🔴 Disabling ambient mode...');
        this.toggleBtn.textContent = "Ambient: Off";
        this.toggleBtn.setAttribute("aria-pressed", "false");
        this.toggleBtn.classList.remove("text-white", "bg-purple-600", "border-purple-600");

        // Remove glass effect class from body
        document.body.classList.remove('ambient-active');
        this.toggleBtn.classList.add("text-gray-600", "bg-white/80", "border-gray-200");

        // Use data-visible attribute for color picker
        this.colorPickerContainer.setAttribute('data-visible', 'false');
        this.closeColorPicker();

        this.vantaBg.style.opacity = "0";

        // Remove glass effect class from denScrollContent
        const denContent = document.getElementById('denScrollContent');
        if (denContent) {
          denContent.classList.remove('ambient-glass-mode');
        }

        if (this.vantaEffect) {
          this.vantaEffect.destroy();
          this.vantaEffect = null;
        }
      }

      loadAmbientPrefs() {
        try {
          const saved = JSON.parse(localStorage.getItem(STORAGE_KEYS.ambient) || "{}");
          if (saved) {
            if (typeof saved.currentSkyColor === "number") {
              this.currentSkyColor = saved.currentSkyColor;
            }
            this.isDynamicMode = !!saved.isDynamicMode;
            this.isActive = !!saved.isActive;

            if (this.isDynamicMode) {
              this.currentColorIndicator.className = "w-3 h-3 rounded-full bg-gradient-to-r from-blue-400 via-yellow-400 to-purple-600";
            } else {
              const colorMap = {
                0x68c7ff: "bg-blue-400",
                0xff6b6b: "bg-red-400",
                0x9b59b6: "bg-purple-400",
                0x2ecc71: "bg-green-400",
              };
              this.currentColorIndicator.className = `w-3 h-3 rounded-full ${colorMap[this.currentSkyColor] || "bg-blue-400"}`;
            }

            if (this.isActive) {
              this.enableAmbientMode();
            } else {
              this.disableAmbientMode();
            }
          }
        } catch {}
      }

      persistAmbientPrefs() {
        const data = {
          currentSkyColor: this.currentSkyColor,
          isDynamicMode: this.isDynamicMode,
          isActive: this.isActive,
        };
        localStorage.setItem(STORAGE_KEYS.ambient, JSON.stringify(data));
      }
    }

    // Initialize on DOMContentLoaded or immediately if already loaded
    function initializeDEN() {
      console.log('🏁 initializeDEN called');
      console.log('🔍 Checking if ambientToggle exists before creating AmbientMode...');
      const preCheck = document.getElementById('ambientToggle');
      console.log('🔍 Pre-check result:', preCheck);

      window.pomodoroTimer = new PomodoroTimer();
      window.ambientMode = new AmbientMode();

      console.log('✅ DEN initialized - pomodoroTimer and ambientMode created');

      window.addEventListener("resize", () => {
        if (window.ambientMode && window.ambientMode.vantaEffect) {
          window.ambientMode.vantaEffect.resize();
        }
      });

      // UI state and menu
      const uiState = {
        compact: false,
        showSettings: true,
        showStats: true,
      };

      let hasSaved = false;
      try {
        const saved = JSON.parse(localStorage.getItem(STORAGE_KEYS.ui) || "{}");
        if (typeof saved.compact === "boolean") {
          uiState.compact = saved.compact;
          hasSaved = true;
        }
        if (typeof saved.showSettings === "boolean") {
          uiState.showSettings = saved.showSettings;
          hasSaved = true;
        }
        if (typeof saved.showStats === "boolean") {
          uiState.showStats = saved.showStats;
          hasSaved = true;
        }
      } catch {}

      if (!hasSaved) {
        if (window.innerHeight < 720) {
          uiState.compact = true;
          if (window.innerHeight < 640) {
            uiState.showSettings = true;
            uiState.showStats = false;
          }
        }
      }

      const settingsCard = document.getElementById("settingsCard");
      const statsCard = document.getElementById("statsCard");
      const moreBtn = document.getElementById("moreOptionsBtn");
      const menu = document.getElementById("moreOptionsMenu");
      const optCompact = document.getElementById("optToggleCompact");
      const optSettings = document.getElementById("optToggleSettings");
      const optStats = document.getElementById("optToggleStats");
      const optAmbient = document.getElementById("optToggleAmbient");
      const optOpenSky = document.getElementById("optOpenSky");
      const optResetToday = document.getElementById("optResetToday");
      const chkCompact = document.getElementById("chkCompact");
      const chkSettings = document.getElementById("chkSettings");
      const chkStats = document.getElementById("chkStats");
      const chkAmbient = document.getElementById("chkAmbient");

      function persistUI() {
        localStorage.setItem(STORAGE_KEYS.ui, JSON.stringify(uiState));
      }

      function applyUI() {
        document.body.classList.toggle("compact", uiState.compact);
        chkCompact.classList.toggle("hidden", !uiState.compact);

        settingsCard.style.display = uiState.showSettings ? "flex" : "none";
        chkSettings.classList.toggle("hidden", !uiState.showSettings);
        statsCard.style.display = uiState.showStats ? "flex" : "none";
        chkStats.classList.toggle("hidden", !uiState.showStats);

        chkAmbient.textContent = window.ambientMode?.isActive ? "On" : "Off";
      }

      applyUI();

      function openMenu() {
        menu.classList.remove("dropdown-enter");
        menu.classList.add("dropdown-open");
        moreBtn.setAttribute("aria-expanded", "true");
      }

      function closeMenu() {
        menu.classList.add("dropdown-enter");
        menu.classList.remove("dropdown-open");
        moreBtn.setAttribute("aria-expanded", "false");
      }

      moreBtn.addEventListener("click", (e) => {
        e.stopPropagation();
        const isOpen = menu.classList.contains("dropdown-open");
        if (isOpen) closeMenu();
        else openMenu();
      });

      document.addEventListener("click", (e) => {
        if (!menu.contains(e.target) && e.target !== moreBtn) {
          closeMenu();
        }
      });

      optCompact.addEventListener("click", () => {
        uiState.compact = !uiState.compact;
        applyUI();
        persistUI();
      });

      optSettings.addEventListener("click", () => {
        uiState.showSettings = !uiState.showSettings;
        applyUI();
        persistUI();
      });

      optStats.addEventListener("click", () => {
        uiState.showStats = !uiState.showStats;
        applyUI();
        persistUI();
      });

      optAmbient.addEventListener("click", () => {
        window.ambientMode.toggle();
        applyUI();
        persistUI();
      });

      optOpenSky.addEventListener("click", () => {
        const toggle = document.getElementById("colorPickerToggle");
        if (toggle) toggle.click();
        closeMenu();
      });

      optResetToday.addEventListener("click", () => {
        try {
          const saved = JSON.parse(localStorage.getItem(STORAGE_KEYS.stats) || "{}");
          const newStats = {
            date: todayStr(),
            sessions: 0,
            streak: saved?.streak || 0,
          };
          localStorage.setItem(STORAGE_KEYS.stats, JSON.stringify(newStats));
          window.pomodoroTimer.completedSessions = 0;
          window.pomodoroTimer.updateStats();
        } catch {}
        closeMenu();
      });
    }

    console.log('📄 DEN content script readyState:', document.readyState);
    if (document.readyState === 'loading') {
      console.log('⏳ Waiting for DOMContentLoaded to initialize DEN...');
      document.addEventListener('DOMContentLoaded', initializeDEN);
    } else {
      console.log('✅ DOM already loaded, initializing DEN immediately...');
      initializeDEN();
    }
  }

  // Music Player Functionality
  document.addEventListener('DOMContentLoaded', () => {
    const musicPlayerToggle = document.getElementById('musicPlayerToggle');
    const musicPlayerExpanded = document.getElementById('musicPlayerExpanded');
    const musicPlayerClose = document.getElementById('musicPlayerClose');
    const audioPlayer = document.getElementById('audioPlayer');
    const playPauseBtn = document.getElementById('playPauseBtn');
    const prevBtn = document.getElementById('prevBtn');
    const nextBtn = document.getElementById('nextBtn');
    const progressContainer = document.getElementById('progressContainer');
    const progressFill = document.getElementById('progressFill');
    const volumeContainer = document.getElementById('volumeContainer');
    const volumeFill = document.getElementById('volumeFill');
    const volumeIcon = document.getElementById('volumeIcon');
    const currentTimeEl = document.getElementById('currentTime');
    const totalTimeEl = document.getElementById('totalTime');
    const currentTrackTitleEl = document.getElementById('currentTrackTitle');
    const playlistItemsEl = document.getElementById('playlistItems');
    const refreshPlaylistBtn = document.getElementById('refreshPlaylist');

    let playlist = [];
    let currentTrackIndex = -1;

    // Toggle to expanded view
    musicPlayerToggle.addEventListener('click', () => {
      musicPlayerToggle.style.display = 'none';
      musicPlayerExpanded.style.display = 'flex';
      if (playlist.length === 0) {
        loadPlaylist();
      }
    });

    // Toggle back to collapsed pill
    musicPlayerClose.addEventListener('click', () => {
      musicPlayerExpanded.style.display = 'none';
      musicPlayerToggle.style.display = 'flex';
    });

    // Load playlist from API
    async function loadPlaylist() {
      try {
        playlistItemsEl.innerHTML = '<div class="playlist-loading"><i class="fas fa-spinner fa-spin"></i> Loading music...</div>';

        const response = await fetch('/api/v1/music', {
          method: 'GET',
          credentials: 'include',
        });

        if (!response.ok) {
          throw new Error('Failed to load playlist');
        }

        const result = await response.json();
        playlist = result.data || [];

        if (playlist.length === 0) {
          playlistItemsEl.innerHTML = `
            <div class="playlist-empty">
              <i class="fas fa-music"></i>
              <span>No music files found</span>
              <span style="font-size: 0.75rem; opacity: 0.7;">Add MP3 files to public/music folder</span>
            </div>
          `;
          return;
        }

        renderPlaylist();

        // Auto-load first track if none is playing
        if (currentTrackIndex === -1) {
          loadTrack(0);
        }

      } catch (error) {
        console.error('Error loading playlist:', error);
        playlistItemsEl.innerHTML = `
          <div class="playlist-empty">
            <i class="fas fa-exclamation-triangle"></i>
            <span>Failed to load playlist</span>
          </div>
        `;
      }
    }

    // Render playlist items
    function renderPlaylist() {
      playlistItemsEl.innerHTML = '';

      playlist.forEach((track, index) => {
        const item = document.createElement('div');
        item.className = 'playlist-item';
        if (index === currentTrackIndex) {
          item.classList.add('active');
        }

        item.innerHTML = `
          <div class="playlist-item-icon">
            <i class="fas fa-${index === currentTrackIndex ? 'volume-up' : 'music'}"></i>
          </div>
          <div class="playlist-item-title">${escapeHtml(track.title)}</div>
        `;

        item.addEventListener('click', () => {
          loadTrack(index);
          audioPlayer.play();
        });

        playlistItemsEl.appendChild(item);
      });
    }

    // Load a track
    function loadTrack(index) {
      if (index < 0 || index >= playlist.length) return;

      currentTrackIndex = index;
      const track = playlist[index];

      audioPlayer.src = `/api/v1/music/stream/${encodeURIComponent(track.filename)}`;
      currentTrackTitleEl.textContent = track.title;

      renderPlaylist();
    }

    // Play/Pause button
    playPauseBtn.addEventListener('click', () => {
      if (audioPlayer.paused) {
        if (currentTrackIndex === -1 && playlist.length > 0) {
          loadTrack(0);
        }
        audioPlayer.play();
      } else {
        audioPlayer.pause();
      }
    });

    // Previous track
    prevBtn.addEventListener('click', () => {
      if (currentTrackIndex > 0) {
        loadTrack(currentTrackIndex - 1);
        audioPlayer.play();
      }
    });

    // Next track
    nextBtn.addEventListener('click', () => {
      if (currentTrackIndex < playlist.length - 1) {
        loadTrack(currentTrackIndex + 1);
        audioPlayer.play();
      } else if (playlist.length > 0) {
        // Loop back to first track
        loadTrack(0);
        audioPlayer.play();
      }
    });

    // Auto-play next track when current ends
    audioPlayer.addEventListener('ended', () => {
      if (currentTrackIndex < playlist.length - 1) {
        loadTrack(currentTrackIndex + 1);
        audioPlayer.play();
      } else {
        // Loop back to first track
        loadTrack(0);
      }
    });

    // Update play/pause icon
    audioPlayer.addEventListener('play', () => {
      playPauseBtn.querySelector('i').className = 'fas fa-pause';
    });

    audioPlayer.addEventListener('pause', () => {
      playPauseBtn.querySelector('i').className = 'fas fa-play';
    });

    // Update progress bar
    audioPlayer.addEventListener('timeupdate', () => {
      if (audioPlayer.duration) {
        const progress = (audioPlayer.currentTime / audioPlayer.duration) * 100;
        progressFill.style.width = `${progress}%`;

        currentTimeEl.textContent = formatTime(audioPlayer.currentTime);
        totalTimeEl.textContent = formatTime(audioPlayer.duration);
      }
    });

    // Add playing class for waveform animation
    audioPlayer.addEventListener('play', () => {
      progressFill.classList.add('playing');
    });

    audioPlayer.addEventListener('pause', () => {
      progressFill.classList.remove('playing');
    });

    audioPlayer.addEventListener('ended', () => {
      progressFill.classList.remove('playing');
    });

    // Seek functionality
    progressContainer.addEventListener('click', (e) => {
      const rect = progressContainer.getBoundingClientRect();
      const percent = (e.clientX - rect.left) / rect.width;
      audioPlayer.currentTime = percent * audioPlayer.duration;
    });

    // Volume control
    let isDraggingVolume = false;

    volumeContainer.addEventListener('mousedown', (e) => {
      isDraggingVolume = true;
      updateVolume(e);
      e.preventDefault();
    });

    document.addEventListener('mousemove', (e) => {
      if (isDraggingVolume) {
        updateVolume(e);
      }
    });

    document.addEventListener('mouseup', () => {
      isDraggingVolume = false;
    });

    volumeContainer.addEventListener('click', (e) => {
      if (!isDraggingVolume) {
        updateVolume(e);
      }
    });

    // Touch support for mobile
    volumeContainer.addEventListener('touchstart', (e) => {
      isDraggingVolume = true;
      const touch = e.touches[0];
      updateVolume(touch);
      e.preventDefault();
    });

    volumeContainer.addEventListener('touchmove', (e) => {
      if (isDraggingVolume) {
        const touch = e.touches[0];
        updateVolume(touch);
      }
    });

    volumeContainer.addEventListener('touchend', () => {
      isDraggingVolume = false;
    });

    function updateVolume(e) {
      const rect = volumeContainer.getBoundingClientRect();
      const clientX = e.clientX || (e.touches && e.touches[0].clientX);
      const percent = Math.max(0, Math.min(1, (clientX - rect.left) / rect.width));
      audioPlayer.volume = percent;
      volumeFill.style.width = `${percent * 100}%`;

      // Update volume icon
      if (percent === 0) {
        volumeIcon.className = 'fas fa-volume-mute volume-icon';
      } else if (percent < 0.5) {
        volumeIcon.className = 'fas fa-volume-down volume-icon';
      } else {
        volumeIcon.className = 'fas fa-volume-up volume-icon';
      }
    }

    // Volume icon click to mute/unmute
    volumeIcon.addEventListener('click', () => {
      if (audioPlayer.volume > 0) {
        audioPlayer.dataset.previousVolume = audioPlayer.volume;
        audioPlayer.volume = 0;
        volumeFill.style.width = '0%';
        volumeIcon.className = 'fas fa-volume-mute volume-icon';
      } else {
        const previousVolume = parseFloat(audioPlayer.dataset.previousVolume) || 0.7;
        audioPlayer.volume = previousVolume;
        volumeFill.style.width = `${previousVolume * 100}%`;
        volumeIcon.className = 'fas fa-volume-up volume-icon';
      }
    });

    // Refresh playlist button
    refreshPlaylistBtn.addEventListener('click', () => {
      loadPlaylist();
    });

    // Helper function to format time
    function formatTime(seconds) {
      if (isNaN(seconds)) return '0:00';
      const mins = Math.floor(seconds / 60);
      const secs = Math.floor(seconds % 60);
      return `${mins}:${secs.toString().padStart(2, '0')}`;
    }

    // Helper function to escape HTML
    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // Set initial volume
    audioPlayer.volume = 0.7;
  });
</script>
