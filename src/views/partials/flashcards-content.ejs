<!-- Flashcards Section Content -->
<div style="height: 100%; display: flex; flex-direction: column; overflow: hidden; background: var(--bg-primary);">
    <!-- Header -->
    <div class="px-8 py-6 border-b border-gray-200" style="background: var(--bg-primary);">
        <div class="flex items-center justify-end mb-4">
            <div class="flex items-center space-x-3">
                <!-- Search -->
                <div class="relative">
                    <i class="fas fa-search absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                    <input
                        type="text"
                        id="searchInput"
                        placeholder="Search flashcards..."
                        class="w-64 pl-10 pr-4 py-2.5 bg-gray-50 border-2 border-gray-200 rounded-full text-gray-800 placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-black focus:border-transparent"
                    />
                </div>

                <!-- Difficulty Filter - Custom Dropdown -->
                <div class="custom-dropdown" id="difficultyDropdownContainer">
                    <button class="custom-dropdown-btn" id="difficultyDropdownBtn" onclick="toggleCustomDropdown('difficulty')">
                        <span id="difficultyDropdownText">All Difficulties</span>
                        <i class="fas fa-chevron-down"></i>
                    </button>
                    <div class="custom-dropdown-menu" id="difficultyDropdownMenu">
                        <div class="custom-dropdown-item" onclick="selectDifficultyFilter('', 'All Difficulties')">All Difficulties</div>
                        <div class="custom-dropdown-item" onclick="selectDifficultyFilter('easy', 'Easy')">Easy</div>
                        <div class="custom-dropdown-item" onclick="selectDifficultyFilter('medium', 'Medium')">Medium</div>
                        <div class="custom-dropdown-item" onclick="selectDifficultyFilter('hard', 'Hard')">Hard</div>
                    </div>
                </div>

                <!-- Tag Filter - Custom Dropdown -->
                <div class="custom-dropdown" id="tagDropdownContainer">
                    <button class="custom-dropdown-btn" id="tagDropdownBtn" onclick="toggleCustomDropdown('tag')">
                        <span id="tagDropdownText">All Tags</span>
                        <i class="fas fa-chevron-down"></i>
                    </button>
                    <div class="custom-dropdown-menu" id="tagDropdownMenu">
                        <div class="custom-dropdown-item" onclick="selectTagFilter('', 'All Tags')">All Tags</div>
                        <!-- Tag options will be dynamically populated -->
                    </div>
                </div>

                <!-- AI Generate Button -->
                <button
                    onclick="openAIGenerateModal()"
                    class="flashcard-tooltip flex items-center justify-center px-5 py-2.5 text-center text-white duration-200 bg-purple-600 border-2 border-purple-600 rounded-full hover:bg-transparent hover:border-purple-600 hover:text-purple-600 focus:outline-none text-sm"
                    data-tooltip="Generate flashcards from notes with AI"
                >
                    <i class="fas fa-sparkles mr-2"></i>
                    AI Generate
                </button>

                <!-- Create Button -->
                <button
                    onclick="openCreateModal()"
                    class="flashcard-tooltip flex items-center justify-center px-5 py-2.5 text-center text-white duration-200 bg-black border-2 border-black rounded-full hover:bg-transparent hover:border-black hover:text-black focus:outline-none text-sm"
                    data-tooltip="Create a new flashcard"
                >
                    <i class="fas fa-plus mr-2"></i>
                    Create Card
                </button>
            </div>
        </div>
    </div>

    <!-- Cards Grid -->
    <div class="flex-1 overflow-y-auto p-8" style="min-height: 0;">
        <div id="loadingState" class="text-center py-20">
            <i class="fas fa-spinner fa-spin text-gray-400 text-5xl mb-4"></i>
            <p class="text-gray-500">Loading flashcards...</p>
        </div>
        <div id="cardsGrid" class="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-4" style="display: none;">
            <!-- Cards will be rendered here -->
        </div>
        <div id="emptyState" class="text-center py-20" style="display: none;">
            <i class="fas fa-layer-group text-gray-300 text-6xl mb-4"></i>
            <h3 class="text-xl font-semibold text-gray-600 mb-2">No flashcards yet</h3>
            <p class="text-gray-500 mb-4">Create your first flashcard or generate them from your notes!</p>
            <div class="flex gap-3 justify-center">
                <button
                    onclick="openCreateModal()"
                    class="px-6 py-3 bg-black text-white rounded-full hover:bg-gray-800 transition"
                >
                    <i class="fas fa-plus mr-2"></i>Create Card
                </button>
                <button
                    onclick="openAIGenerateModal()"
                    class="px-6 py-3 bg-purple-600 text-white rounded-full hover:bg-purple-700 transition"
                >
                    <i class="fas fa-sparkles mr-2"></i>AI Generate
                </button>
            </div>
        </div>
        <div id="errorState" class="text-center py-20" style="display: none;">
            <i class="fas fa-exclamation-triangle text-red-400 text-5xl mb-4"></i>
            <h3 class="text-xl font-semibold text-gray-600 mb-2">Error Loading Flashcards</h3>
            <p class="text-gray-500 mb-4" id="errorMessage"></p>
            <button onclick="loadFlashcards()" class="px-6 py-3 bg-black text-white rounded-full hover:bg-gray-800 transition">
                <i class="fas fa-redo mr-2"></i>Retry
            </button>
        </div>
    </div>
</div>

<!-- Flashcard Styles -->
<style>
    /* Custom Dropdown Styles */
    .custom-dropdown {
        position: relative;
        display: inline-block;
    }

    .custom-dropdown-btn {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.625rem 1rem;
        background: var(--bg-secondary, #f9fafb);
        border: 2px solid var(--border-color, #e5e7eb);
        border-radius: 9999px;
        color: var(--text-primary, #1f2937);
        font-size: 0.875rem;
        cursor: pointer;
        transition: all 0.2s ease;
        min-width: 150px;
        justify-content: space-between;
        user-select: none;
        -webkit-user-select: none;
        -moz-user-select: none;
        -ms-user-select: none;
    }

    .custom-dropdown-btn:hover {
        background: var(--bg-tertiary, #f3f4f6);
        border-color: var(--text-secondary, #6b7280);
    }

    .custom-dropdown-btn:focus {
        outline: none;
        ring: 2px;
        ring-color: #000;
        border-color: #000;
    }

    .custom-dropdown-btn i {
        font-size: 0.75rem;
        transition: transform 0.2s ease;
        pointer-events: none;
    }

    .custom-dropdown.open .custom-dropdown-btn i {
        transform: rotate(180deg);
    }

    .custom-dropdown-menu {
        position: absolute;
        top: calc(100% + 0.5rem);
        left: 0;
        right: 0;
        background: var(--bg-secondary, #fff);
        border: 2px solid var(--border-color, #e5e7eb);
        border-radius: 1rem;
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
        opacity: 0;
        visibility: hidden;
        transform: translateY(-10px);
        transition: all 0.2s ease;
        z-index: 1000;
        max-height: 250px;
        overflow-y: auto;
        user-select: none;
        -webkit-user-select: none;
        -moz-user-select: none;
        -ms-user-select: none;
    }

    .custom-dropdown.open .custom-dropdown-menu {
        opacity: 1;
        visibility: visible;
        transform: translateY(0);
    }

    .custom-dropdown-item {
        padding: 0.75rem 1rem;
        cursor: pointer;
        transition: background 0.15s ease;
        color: var(--text-primary, #1f2937);
        font-size: 0.875rem;
    }

    .custom-dropdown-item:first-child {
        border-radius: 0.875rem 0.875rem 0 0;
    }

    .custom-dropdown-item:last-child {
        border-radius: 0 0 0.875rem 0.875rem;
    }

    .custom-dropdown-item:hover {
        background: var(--bg-hover, rgba(0, 0, 0, 0.05));
    }

    [data-theme="dark"] .custom-dropdown-item:hover {
        background: rgba(255, 255, 255, 0.05);
    }

    .custom-dropdown-item.selected {
        background: var(--accent-primary, #000);
        color: #fff;
    }

    .custom-dropdown-item.selected:hover {
        background: var(--accent-secondary, #374151);
    }

    /* Dark mode support */
    [data-theme="dark"] .custom-dropdown-btn {
        background: var(--bg-tertiary);
        border-color: var(--border-color);
        color: var(--text-primary);
    }

    [data-theme="dark"] .custom-dropdown-btn:hover {
        background: var(--bg-secondary);
    }

    [data-theme="dark"] .custom-dropdown-menu {
        background: var(--bg-secondary);
        border-color: var(--border-color);
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
    }

    /* Styled scrollbar for custom dropdown menus */
    .custom-dropdown-menu::-webkit-scrollbar {
        width: 6px;
    }

    .custom-dropdown-menu::-webkit-scrollbar-track {
        background: transparent;
        margin: 4px 0;
    }

    .custom-dropdown-menu::-webkit-scrollbar-thumb {
        background: #cbd5e1;
        border-radius: 10px;
    }

    .custom-dropdown-menu::-webkit-scrollbar-thumb:hover {
        background: #94a3b8;
    }

    [data-theme="dark"] .custom-dropdown-menu::-webkit-scrollbar-thumb {
        background: #4a5568;
    }

    [data-theme="dark"] .custom-dropdown-menu::-webkit-scrollbar-thumb:hover {
        background: #718096;
    }

    /* Styled scrollbar for flashcards grid container */
    .flex-1.overflow-y-auto.p-8::-webkit-scrollbar {
        width: 8px;
    }

    .flex-1.overflow-y-auto.p-8::-webkit-scrollbar-track {
        background: transparent;
        margin: 8px 0;
    }

    .flex-1.overflow-y-auto.p-8::-webkit-scrollbar-thumb {
        background: #cbd5e1;
        border-radius: 10px;
        border: 2px solid transparent;
        background-clip: content-box;
    }

    .flex-1.overflow-y-auto.p-8::-webkit-scrollbar-thumb:hover {
        background: #94a3b8;
        background-clip: content-box;
    }

    [data-theme="dark"] .flex-1.overflow-y-auto.p-8::-webkit-scrollbar-thumb {
        background: #4a5568;
    }

    [data-theme="dark"] .flex-1.overflow-y-auto.p-8::-webkit-scrollbar-thumb:hover {
        background: #718096;
    }

    /* Firefox scrollbar for flashcards grid */
    .flex-1.overflow-y-auto.p-8 {
        scrollbar-width: thin;
        scrollbar-color: #cbd5e1 transparent;
    }

    [data-theme="dark"] .flex-1.overflow-y-auto.p-8 {
        scrollbar-color: #4a5568 transparent;
    }

    /* Styled scrollbar for modal content */
    .flashcard-modal::-webkit-scrollbar {
        width: 8px;
    }

    .flashcard-modal::-webkit-scrollbar-track {
        background: transparent;
        margin: 8px 0;
    }

    .flashcard-modal::-webkit-scrollbar-thumb {
        background: #cbd5e1;
        border-radius: 10px;
        border: 2px solid transparent;
        background-clip: content-box;
    }

    .flashcard-modal::-webkit-scrollbar-thumb:hover {
        background: #94a3b8;
        background-clip: content-box;
    }

    [data-theme="dark"] .flashcard-modal::-webkit-scrollbar-thumb {
        background: #4a5568;
    }

    [data-theme="dark"] .flashcard-modal::-webkit-scrollbar-thumb:hover {
        background: #718096;
    }

    /* Firefox scrollbar for modal */
    .flashcard-modal {
        scrollbar-width: thin;
        scrollbar-color: #cbd5e1 transparent;
    }

    [data-theme="dark"] .flashcard-modal {
        scrollbar-color: #4a5568 transparent;
    }

    /* Prevent text selection on interactive elements */
    button,
    .flashcard,
    .flashcard-option,
    .set-item,
    .modal-overlay,
    i.fas,
    i.far {
        user-select: none;
        -webkit-user-select: none;
        -moz-user-select: none;
        -ms-user-select: none;
    }

    /* Ensure icons don't capture pointer events */
    button i.fas,
    button i.far {
        pointer-events: none;
    }

    /* Allow text selection in inputs */
    input[type="text"],
    textarea {
        user-select: text;
        -webkit-user-select: text;
        -moz-user-select: text;
        -ms-user-select: text;
    }

    /* Flashcard styling */
    .flashcard {
        perspective: 1000px;
        height: 200px;
        cursor: pointer;
        position: relative;
    }

    .card-inner {
        position: relative;
        width: 100%;
        height: 100%;
        text-align: center;
        transition: transform 0.6s;
        transform-style: preserve-3d;
    }

    .flashcard.flipped .card-inner {
        transform: rotateY(180deg);
    }

    .card-face {
        position: absolute;
        width: 100%;
        height: 100%;
        backface-visibility: hidden;
        border-radius: 1.5rem;
        padding: 1.5rem;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        border: 2px solid #e5e7eb;
    }

    .card-front {
        background: white;
    }

    .card-back {
        background: white;
        transform: rotateY(180deg);
    }

    [data-theme="dark"] .card-front,
    [data-theme="dark"] .card-back {
        background: var(--bg-secondary);
        border-color: var(--border-color);
    }

    .card-badges {
        position: absolute;
        top: 1rem;
        left: 1rem;
        right: 1rem;
        display: flex;
        gap: 0.5rem;
        flex-wrap: wrap;
        z-index: 1;
    }

    .difficulty-badge {
        padding: 0.25rem 0.75rem;
        border-radius: 9999px;
        font-size: 0.75rem;
        font-weight: 600;
        text-transform: uppercase;
        background: #000000;
        color: #ffffff;
    }

    .difficulty-easy {
        background: #000000;
        color: #ffffff;
    }

    .difficulty-medium {
        background: #000000;
        color: #ffffff;
    }

    .difficulty-hard {
        background: #000000;
        color: #ffffff;
    }

    [data-theme="dark"] .difficulty-easy {
        background: #000000;
        color: #ffffff;
    }

    [data-theme="dark"] .difficulty-medium {
        background: #000000;
        color: #ffffff;
    }

    [data-theme="dark"] .difficulty-hard {
        background: #000000;
        color: #ffffff;
    }

    .tag-badge {
        padding: 0.25rem 0.75rem;
        border-radius: 9999px;
        font-size: 0.7rem;
        font-weight: 500;
        background: #000000;
        color: #ffffff;
    }

    [data-theme="dark"] .tag-badge {
        background: #000000;
        color: #ffffff;
    }

    .ai-badge {
        padding: 0.25rem 0.75rem;
        border-radius: 9999px;
        font-size: 0.7rem;
        font-weight: 600;
        background: #000000;
        color: #ffffff;
    }

    .card-content {
        flex: 1;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 2rem 1rem 1rem;
        overflow-y: auto;
    }

    .question, .answer {
        font-size: 0.95rem;
        font-weight: 500;
        color: #1f2937;
        line-height: 1.5;
        word-break: break-word;
    }

    [data-theme="dark"] .question,
    [data-theme="dark"] .answer {
        color: var(--text-primary);
    }

    .card-actions {
        position: absolute;
        bottom: 0.75rem;
        left: 0.75rem;
        right: 0.75rem;
        display: flex;
        gap: 0.5rem;
        justify-content: center;
        opacity: 0;
        transition: opacity 0.2s;
    }

    .flashcard:hover .card-actions {
        opacity: 1;
    }

    .flashcard.flipped .card-actions {
        opacity: 0 !important;
        pointer-events: none;
    }

    .icon-btn {
        width: 32px;
        height: 32px;
        border-radius: 50%;
        border: 2px solid #e5e7eb;
        background: white;
        color: #6b7280;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: all 0.2s;
        font-size: 0.85rem;
    }

    .icon-btn:hover {
        background: #f3f4f6;
        color: #1f2937;
        border-color: #d1d5db;
    }

    .icon-btn.delete:hover {
        background: #fee2e2;
        color: #dc2626;
        border-color: #dc2626;
    }

    .icon-btn.pin.active {
        background: #fef3c7;
        color: #f59e0b;
        border-color: #f59e0b;
    }

    .icon-btn.favorite.active {
        background: #fee2e2;
        color: #dc2626;
        border-color: #dc2626;
    }

    [data-theme="dark"] .icon-btn {
        background: var(--bg-tertiary);
        border-color: var(--border-color);
        color: var(--text-secondary);
    }

    [data-theme="dark"] .icon-btn:hover {
        background: var(--bg-primary);
        color: var(--text-primary);
    }

    /* Custom tooltip for flashcards buttons */
    .flashcard-tooltip {
        position: relative;
    }

    .flashcard-tooltip:hover::before {
        content: attr(data-tooltip);
        position: absolute;
        top: 100%;
        left: 50%;
        transform: translateX(-50%);
        background-color: rgba(0, 0, 0, 0.8);
        color: white;
        padding: 8px 12px;
        border-radius: 6px;
        font-size: 12px;
        white-space: nowrap;
        z-index: 10001;
        margin-top: 8px;
        opacity: 0;
        animation: tooltipFadeIn 0.3s ease forwards;
    }

    .flashcard-tooltip:hover::after {
        content: "";
        position: absolute;
        top: 100%;
        left: 50%;
        transform: translateX(-50%);
        border: 5px solid transparent;
        border-bottom-color: rgba(0, 0, 0, 0.8);
        margin-top: 3px;
        opacity: 0;
        z-index: 10001;
        animation: tooltipFadeIn 0.3s ease forwards;
    }

    @keyframes tooltipFadeIn {
        to {
            opacity: 1;
        }
    }
</style>

<style>
    .flashcard-modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100vw;
        height: 100vh;
        background: rgba(0, 0, 0, 0.5);
        backdrop-filter: blur(4px);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 10000;
        opacity: 0;
        transition: opacity 0.2s;
    }

    .flashcard-modal-overlay.active {
        opacity: 1;
    }

    .flashcard-modal {
        background: white;
        border-radius: 1.5rem;
        padding: 2rem;
        max-width: 600px;
        width: 90%;
        max-height: 90vh;
        overflow-y: auto;
        box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
        transform: scale(0.9) translateY(20px);
        transition: all 0.2s;
    }

    .flashcard-modal-overlay.active .flashcard-modal {
        transform: scale(1) translateY(0);
    }

    .flashcard-modal h2 {
        font-size: 1.5rem;
        font-weight: 700;
        color: #1f2937;
        margin-bottom: 1.5rem;
        font-family: "Space Grotesk", sans-serif;
    }

    .flashcard-modal label {
        display: block;
        font-size: 0.875rem;
        font-weight: 600;
        color: #374151;
        margin-bottom: 0.5rem;
        margin-top: 1rem;
    }

    .flashcard-modal input,
    .flashcard-modal textarea,
    .flashcard-modal select {
        width: 100%;
        padding: 0.75rem 1rem;
        border: 2px solid #e5e7eb;
        border-radius: 0.75rem;
        font-size: 1rem;
        color: #1f2937;
        transition: all 0.2s;
        font-family: "IBM Plex Sans", sans-serif;
    }

    .flashcard-modal input:focus,
    .flashcard-modal textarea:focus,
    .flashcard-modal select:focus {
        outline: none;
        border-color: #000;
        box-shadow: 0 0 0 3px rgba(0, 0, 0, 0.1);
    }

    .flashcard-modal textarea {
        resize: vertical;
        min-height: 100px;
    }

    .modal-actions {
        display: flex;
        gap: 0.75rem;
        margin-top: 2rem;
        justify-content: flex-end;
    }

    .modal-actions button {
        padding: 0.75rem 1.5rem;
        border-radius: 9999px;
        font-weight: 600;
        font-size: 0.875rem;
        cursor: pointer;
        transition: all 0.2s;
        border: 2px solid;
    }

    .modal-actions .btn-cancel {
        background: white;
        color: #6b7280;
        border-color: #e5e7eb;
    }

    .modal-actions .btn-cancel:hover {
        background: #f3f4f6;
        border-color: #d1d5db;
    }

    .modal-actions .btn-primary {
        background: #000;
        color: white;
        border-color: #000;
    }

    .modal-actions .btn-primary:hover {
        background: transparent;
        color: #000;
    }

    .modal-actions .btn-danger {
        background: #dc2626;
        color: white;
        border-color: #dc2626;
    }

    .modal-actions .btn-danger:hover {
        background: transparent;
        color: #dc2626;
    }

    .modal-actions .btn-primary:disabled,
    .modal-actions .btn-danger:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }

    .muted-small {
        font-size: 0.75rem;
        color: #9ca3af;
        margin-top: 0.5rem;
    }

    .note-item {
        padding: 1rem;
        border: 2px solid #e5e7eb;
        border-radius: 0.75rem;
        cursor: pointer;
        transition: all 0.2s;
        margin-bottom: 0.75rem;
    }

    .note-item:hover {
        border-color: #000;
        background: #f9fafb;
    }

    .note-item.selected {
        border-color: #000;
        background: #f3f4f6;
    }

    .note-title {
        font-weight: 600;
        color: #1f2937;
        margin-bottom: 0.25rem;
    }

    .note-preview {
        font-size: 0.875rem;
        color: #6b7280;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }

    .tag-input-container {
        display: flex;
        flex-wrap: wrap;
        gap: 0.5rem;
        padding: 0.75rem;
        border: 2px solid #e5e7eb;
        border-radius: 0.75rem;
        min-height: 48px;
    }

    .tag-input-container:focus-within {
        border-color: #000;
        box-shadow: 0 0 0 3px rgba(0, 0, 0, 0.1);
    }

    .tag-chip {
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.25rem 0.75rem;
        background: #f3f4f6;
        color: #1f2937;
        border-radius: 9999px;
        font-size: 0.875rem;
    }

    .tag-chip button {
        background: none;
        border: none;
        color: #6b7280;
        cursor: pointer;
        padding: 0;
        font-size: 0.75rem;
    }

    .tag-chip button:hover {
        color: #1f2937;
    }

    .tag-input {
        border: none;
        outline: none;
        flex: 1;
        min-width: 100px;
        font-size: 1rem;
        color: #1f2937;
    }

    /* Dark mode for header elements */
    [data-theme="dark"] .border-gray-200 {
        border-color: var(--border-color);
    }

    [data-theme="dark"] input[type="text"],
    [data-theme="dark"] select {
        background: var(--bg-tertiary);
        color: var(--text-primary);
        border-color: var(--border-color);
    }

    [data-theme="dark"] input::placeholder {
        color: var(--text-secondary);
    }

    [data-theme="dark"] .text-gray-400,
    [data-theme="dark"] .text-gray-500,
    [data-theme="dark"] .text-gray-600,
    [data-theme="dark"] .text-gray-300 {
        color: var(--text-primary);
    }

    /* Dark mode for modals */
    [data-theme="dark"] .flashcard-modal {
        background: var(--bg-secondary);
    }

    [data-theme="dark"] .flashcard-modal h2 {
        color: var(--text-primary);
    }

    [data-theme="dark"] .flashcard-modal label {
        color: var(--text-secondary);
    }

    [data-theme="dark"] .flashcard-modal input,
    [data-theme="dark"] .flashcard-modal textarea,
    [data-theme="dark"] .flashcard-modal select {
        background: var(--bg-tertiary);
        border-color: var(--border-color);
        color: var(--text-primary);
    }

    [data-theme="dark"] .modal-actions .btn-cancel {
        background: var(--bg-tertiary);
        color: var(--text-secondary);
        border-color: var(--border-color);
    }

    [data-theme="dark"] .modal-actions .btn-cancel:hover {
        background: var(--bg-primary);
    }

    [data-theme="dark"] .note-item {
        border-color: var(--border-color);
    }

    [data-theme="dark"] .note-item:hover {
        border-color: var(--text-primary);
        background: var(--bg-tertiary);
    }

    [data-theme="dark"] .note-item.selected {
        border-color: var(--text-primary);
        background: var(--bg-tertiary);
    }

    [data-theme="dark"] .note-title {
        color: var(--text-primary);
    }

    [data-theme="dark"] .note-preview {
        color: var(--text-secondary);
    }

    [data-theme="dark"] .tag-input-container {
        background: var(--bg-tertiary);
        border-color: var(--border-color);
    }

    [data-theme="dark"] .tag-chip {
        background: var(--bg-primary);
        color: var(--text-primary);
    }

    [data-theme="dark"] .tag-input {
        background: transparent;
        color: var(--text-primary);
    }
    /* Modal dropdown specific styles */
    .modal-dropdown-btn {
        width: 100%;
        min-width: auto;
    }

    .flashcard-modal .custom-dropdown {
        width: 100%;
    }

    .flashcard-modal .custom-dropdown-menu {
        left: 0;
        right: 0;
    }
</style>

<!-- Flashcards JavaScript -->

<script>
    // Custom Dropdown Functions
    let currentDifficultyFilter = '';
    let currentTagFilter = '';

    function toggleCustomDropdown(type) {
        const container = document.getElementById(type + 'DropdownContainer');
        const isOpen = container.classList.contains('open');

        // Close all dropdowns first
        document.querySelectorAll('.custom-dropdown').forEach(dd => {
            dd.classList.remove('open');
        });

        // Toggle current dropdown
        if (!isOpen) {
            container.classList.add('open');

            // Close dropdown when clicking outside
            setTimeout(() => {
                document.addEventListener('click', closeDropdownOutside);
            }, 0);
        }
    }

    function closeDropdownOutside(e) {
        if (!e.target.closest('.custom-dropdown')) {
            document.querySelectorAll('.custom-dropdown').forEach(dd => {
                dd.classList.remove('open');
            });
            document.removeEventListener('click', closeDropdownOutside);
        }
    }

    function selectDifficultyFilter(value, label) {
        currentDifficultyFilter = value;
        document.getElementById('difficultyDropdownText').textContent = label;
        document.getElementById('difficultyDropdownContainer').classList.remove('open');
        applyFilters();
    }

    function selectTagFilter(value, label) {
        currentTagFilter = value;
        document.getElementById('tagDropdownText').textContent = label;
        document.getElementById('tagDropdownContainer').classList.remove('open');
        applyFilters();
    }

    // Modal dropdown functions
    function toggleModalDropdown(type) {
        const container = document.getElementById(type + 'DropdownContainer');
        const isOpen = container.classList.contains('open');

        // Close all modal dropdowns first
        document.querySelectorAll('.modal-dropdown').forEach(dd => {
            dd.classList.remove('open');
        });

        // Toggle current dropdown
        if (!isOpen) {
            container.classList.add('open');
        }
    }

    function selectModalDifficulty(type, value, label) {
        // Update hidden input
        document.getElementById(type).value = value;

        // Update button text
        document.getElementById(type + 'DropdownText').textContent = label;

        // Update selected state
        const menu = document.getElementById(type + 'DropdownMenu');
        menu.querySelectorAll('.custom-dropdown-item').forEach(item => {
            item.classList.remove('selected');
        });
        event.target.classList.add('selected');

        // Close dropdown
        document.getElementById(type + 'DropdownContainer').classList.remove('open');
    }

    // Flashcards state
    let flashcards = [];
    let currentFilters = {
        difficulty: '',
        tag: '',
        search: ''
    };

    // API base URL
    const API_BASE = '/api/v1/cards';

    // Helper functions
    function escapeHtml(unsafe) {
        if (!unsafe) return '';
        return String(unsafe)
            .replace(/&/g, "&amp;")
            .replace(/</g, "&lt;")
            .replace(/>/g, "&gt;")
            .replace(/"/g, "&quot;")
            .replace(/'/g, "&#039;");
    }

    function showToast(message, type = 'success') {
        // Simple toast notification
        const toast = document.createElement('div');
        toast.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 1rem 1.5rem;
            background: ${type === 'success' ? '#10b981' : '#ef4444'};
            color: white;
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            z-index: 10001;
            font-weight: 500;
        `;
        toast.textContent = message;
        document.body.appendChild(toast);
        setTimeout(() => toast.remove(), 3000);
    }

    function showLoading() {
        document.getElementById('loadingState').style.display = 'block';
        document.getElementById('cardsGrid').style.display = 'none';
        document.getElementById('emptyState').style.display = 'none';
        document.getElementById('errorState').style.display = 'none';
    }

    function showError(message) {
        document.getElementById('loadingState').style.display = 'none';
        document.getElementById('cardsGrid').style.display = 'none';
        document.getElementById('emptyState').style.display = 'none';
        document.getElementById('errorState').style.display = 'block';
        document.getElementById('errorMessage').textContent = message;
    }

    function showContent() {
        document.getElementById('loadingState').style.display = 'none';
        document.getElementById('errorState').style.display = 'none';
        if (flashcards.length === 0) {
            document.getElementById('cardsGrid').style.display = 'none';
            document.getElementById('emptyState').style.display = 'block';
        } else {
            document.getElementById('cardsGrid').style.display = 'grid';
            document.getElementById('emptyState').style.display = 'none';
        }
    }

    // API calls
    async function apiRequest(url, options = {}) {
        try {
            const response = await fetch(url, {
                ...options,
                headers: {
                    'Content-Type': 'application/json',
                    ...options.headers
                }
            });

            const data = await response.json();

            if (!response.ok) {
                throw new Error(data.message || 'Request failed');
            }

            return data;
        } catch (error) {
            console.error('API Error:', error);
            throw error;
        }
    }

    async function loadFlashcards() {
        showLoading();
        try {
            const params = new URLSearchParams();
            if (currentFilters.difficulty) params.append('difficulty', currentFilters.difficulty);

            const url = currentFilters.search
                ? `${API_BASE}/search?query=${encodeURIComponent(currentFilters.search)}`
                : `${API_BASE}?${params.toString()}`;

            const response = await apiRequest(url);
            flashcards = response.data.cards || response.data;

            // Apply tag filter on frontend if needed
            if (currentFilters.tag) {
                flashcards = flashcards.filter(card =>
                    card.tags && card.tags.includes(currentFilters.tag)
                );
            }

            await updateTagOptions();
            renderCards();
            showContent();
        } catch (error) {
            showError(error.message || 'Failed to load flashcards');
        }
    }

    async function updateTagOptions() {
        try {
            const response = await apiRequest(`${API_BASE}/tags`);
            const tags = response.data.tags || [];

            const menu = document.getElementById('tagDropdownMenu');
            const currentValue = currentTagFilter;

            menu.innerHTML = '<div class="custom-dropdown-item" onclick="selectTagFilter(\'\', \'All Tags\')">All Tags</div>';
            tags.forEach(tag => {
                const item = document.createElement('div');
                item.className = 'custom-dropdown-item';
                item.textContent = tag;
                item.onclick = () => selectTagFilter(tag, tag);
                if (tag === currentValue) {
                    item.classList.add('selected');
                }
                menu.appendChild(item);
            });

        } catch (error) {
            console.error('Failed to load tags:', error);
        }
    }

    function renderCards() {
        const grid = document.getElementById('cardsGrid');

        if (flashcards.length === 0) {
            showContent();
            return;
        }

        grid.innerHTML = flashcards.map(card => {
            const difficultyClass = `difficulty-${card.difficulty || 'medium'}`;
            const firstTag = card.tags && card.tags.length > 0 ? card.tags[0] : null;

            return `
                <div class="flashcard" data-id="${card._id}">
                    <div class="card-inner">
                        <!-- Front -->
                        <div class="card-face card-front">
                            <div class="card-badges">
                                <span class="difficulty-badge ${difficultyClass}">${card.difficulty || 'medium'}</span>
                                ${card.isAIGenerated ? '<span class="ai-badge"><i class="fas fa-sparkles"></i> AI</span>' : ''}
                                ${firstTag ? `<span class="tag-badge">${escapeHtml(firstTag)}</span>` : ''}
                            </div>
                            <div class="card-content">
                                <p class="question">${escapeHtml(card.title)}</p>
                            </div>
                            <div class="card-actions">
                                <button class="icon-btn pin ${card.isPinned ? 'active' : ''}" onclick="event.stopPropagation(); togglePin('${card._id}')" title="${card.isPinned ? 'Unpin' : 'Pin'}">
                                    <i class="fas fa-thumbtack"></i>
                                </button>
                                <button class="icon-btn favorite ${card.isFavorite ? 'active' : ''}" onclick="event.stopPropagation(); toggleFavorite('${card._id}')" title="${card.isFavorite ? 'Unfavorite' : 'Favorite'}">
                                    <i class="fas fa-heart"></i>
                                </button>
                                <button class="icon-btn" onclick="event.stopPropagation(); openEditModal('${card._id}')" title="Edit">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="icon-btn delete" onclick="event.stopPropagation(); openDeleteModal('${card._id}')" title="Delete">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                        <!-- Back -->
                        <div class="card-face card-back">
                            <div class="card-badges">
                                <span class="difficulty-badge ${difficultyClass}">${card.difficulty || 'medium'}</span>
                                ${card.isAIGenerated ? '<span class="ai-badge"><i class="fas fa-sparkles"></i> AI</span>' : ''}
                                ${firstTag ? `<span class="tag-badge">${escapeHtml(firstTag)}</span>` : ''}
                            </div>
                            <div class="card-content">
                                <p class="answer">${escapeHtml(card.content)}</p>
                            </div>
                            <div class="card-actions">
                                <button class="icon-btn pin ${card.isPinned ? 'active' : ''}" onclick="event.stopPropagation(); togglePin('${card._id}')" title="${card.isPinned ? 'Unpin' : 'Pin'}">
                                    <i class="fas fa-thumbtack"></i>
                                </button>
                                <button class="icon-btn favorite ${card.isFavorite ? 'active' : ''}" onclick="event.stopPropagation(); toggleFavorite('${card._id}')" title="${card.isFavorite ? 'Unfavorite' : 'Favorite'}">
                                    <i class="fas fa-heart"></i>
                                </button>
                                <button class="icon-btn" onclick="event.stopPropagation(); openEditModal('${card._id}')" title="Edit">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="icon-btn delete" onclick="event.stopPropagation(); openDeleteModal('${card._id}')" title="Delete">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }).join('');

        // Add flip listeners
        document.querySelectorAll('.flashcard').forEach(card => {
            card.addEventListener('click', async (e) => {
                if (!e.target.closest('.card-actions')) {
                    card.classList.toggle('flipped');

                    // Mark as reviewed when flipped
                    if (card.classList.contains('flipped')) {
                        const cardId = card.dataset.id;
                        try {
                            await apiRequest(`${API_BASE}/${cardId}/review`, { method: 'PATCH' });
                        } catch (error) {
                            console.error('Failed to mark as reviewed:', error);
                        }
                    }
                }
            });
        });
    }

    // Filter and search
    function applyFilters() {
        currentFilters.difficulty = currentDifficultyFilter;
        currentFilters.tag = currentTagFilter;
        currentFilters.search = document.getElementById('searchInput').value.trim();
        loadFlashcards();
    }

    // Debounce search
    let searchTimeout;
    function handleSearch() {
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(() => {
            applyFilters();
        }, 500);
    }

    // Modal helpers
    function createModal(content) {
        const overlay = document.getElementById('flashcardModalOverlay');
        const container = document.getElementById('flashcardModalContainer');
        if (!overlay || !container) {
            console.error('Modal elements not found');
            return;
        }
        container.innerHTML = content;
        overlay.style.display = 'flex';
        setTimeout(() => overlay.classList.add('active'), 10);

        // Focus first input
        const firstInput = container.querySelector('input, textarea');
        if (firstInput) setTimeout(() => firstInput.focus(), 100);
    }

    function closeModal() {
        const overlay = document.getElementById('flashcardModalOverlay');
        if (!overlay) return;
        overlay.classList.remove('active');
        setTimeout(() => overlay.style.display = 'none', 200);
    }

    // Create modal
    function openCreateModal() {
        const modal = `
            <div class="flashcard-modal">
                <h2><i class="fas fa-plus-circle mr-2"></i>Create New Flashcard</h2>
                <form onsubmit="event.preventDefault(); createCard()">
                    <label>Title (Question) <span style="color: #dc2626;">*</span></label>
                    <textarea id="newTitle" placeholder="Enter your question..." required maxlength="500"></textarea>
                    <p class="muted-small">Max 500 characters</p>

                    <label>Content (Answer) <span style="color: #dc2626;">*</span></label>
                    <textarea id="newContent" placeholder="Enter the answer..." required maxlength="2000"></textarea>
                    <p class="muted-small">Max 2000 characters</p>

                    <label>Difficulty</label>
                    <div class="custom-dropdown modal-dropdown" id="newDifficultyDropdownContainer">
                        <button type="button" class="custom-dropdown-btn modal-dropdown-btn" id="newDifficultyDropdownBtn" onclick="toggleModalDropdown('newDifficulty')">
                            <span id="newDifficultyDropdownText">Medium</span>
                            <i class="fas fa-chevron-down"></i>
                        </button>
                        <div class="custom-dropdown-menu" id="newDifficultyDropdownMenu">
                            <div class="custom-dropdown-item" onclick="selectModalDifficulty('newDifficulty', 'easy', 'Easy')">Easy</div>
                            <div class="custom-dropdown-item selected" onclick="selectModalDifficulty('newDifficulty', 'medium', 'Medium')">Medium</div>
                            <div class="custom-dropdown-item" onclick="selectModalDifficulty('newDifficulty', 'hard', 'Hard')">Hard</div>
                        </div>
                    </div>
                    <input type="hidden" id="newDifficulty" value="medium">

                    <label>Tags</label>
                    <div class="tag-input-container" id="newTagsContainer">
                        <input type="text" class="tag-input" id="newTagInput" placeholder="Type and press Enter to add tags..." />
                    </div>
                    <p class="muted-small">Press Enter to add tags (max 10)</p>

                    <div class="modal-actions">
                        <button type="button" class="btn-cancel" onclick="closeModal()">Cancel</button>
                        <button type="submit" class="btn-primary">Create Card</button>
                    </div>
                </form>
            </div>
        `;
        createModal(modal);
        initializeTagInput('newTagInput', 'newTagsContainer');
    }

    function initializeTagInput(inputId, containerId) {
        const input = document.getElementById(inputId);
        const container = document.getElementById(containerId);
        const tags = [];

        input.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                e.preventDefault();
                const value = input.value.trim().toLowerCase();
                if (value && !tags.includes(value) && tags.length < 10) {
                    tags.push(value);
                    renderTags();
                    input.value = '';
                }
            }
        });

        function renderTags() {
            const existingTags = container.querySelectorAll('.tag-chip');
            existingTags.forEach(tag => tag.remove());

            tags.forEach((tag, index) => {
                const chip = document.createElement('span');
                chip.className = 'tag-chip';
                chip.innerHTML = `
                    ${escapeHtml(tag)}
                    <button type="button" onclick="this.parentElement.remove(); window.flashcardTags_${inputId}.splice(${index}, 1);">
                        <i class="fas fa-times"></i>
                    </button>
                `;
                container.insertBefore(chip, input);
            });
        }

        // Store tags globally for access
        window[`flashcardTags_${inputId}`] = tags;
    }

    async function createCard() {
        const title = document.getElementById('newTitle').value.trim();
        const content = document.getElementById('newContent').value.trim();
        const difficulty = document.getElementById('newDifficulty').value;
        const tags = window.flashcardTags_newTagInput || [];

        if (!title || !content) {
            showToast('Title and content are required', 'error');
            return;
        }

        if (title.length > 500) {
            showToast('Title cannot exceed 500 characters', 'error');
            return;
        }

        if (content.length > 2000) {
            showToast('Content cannot exceed 2000 characters', 'error');
            return;
        }

        try {
            await apiRequest(API_BASE, {
                method: 'POST',
                body: JSON.stringify({
                    title,
                    content,
                    difficulty,
                    tags
                })
            });

            showToast('Flashcard created successfully!');
            closeModal();
            loadFlashcards();
        } catch (error) {
            showToast(error.message || 'Failed to create flashcard', 'error');
        }
    }

    // Edit modal
    function openEditModal(id) {
        const card = flashcards.find(c => c._id === id);
        if (!card) return;

        const modal = `
            <div class="flashcard-modal">
                <h2><i class="fas fa-edit mr-2"></i>Edit Flashcard</h2>
                <form onsubmit="event.preventDefault(); updateCard('${id}')">
                    <label>Title (Question) <span style="color: #dc2626;">*</span></label>
                    <textarea id="editTitle" required maxlength="500">${escapeHtml(card.title)}</textarea>

                    <label>Content (Answer) <span style="color: #dc2626;">*</span></label>
                    <textarea id="editContent" required maxlength="2000">${escapeHtml(card.content)}</textarea>

                    <label>Difficulty</label>
                    <div class="custom-dropdown modal-dropdown" id="editDifficultyDropdownContainer">
                        <button type="button" class="custom-dropdown-btn modal-dropdown-btn" id="editDifficultyDropdownBtn" onclick="toggleModalDropdown('editDifficulty')">
                            <span id="editDifficultyDropdownText">${card.difficulty.charAt(0).toUpperCase() + card.difficulty.slice(1)}</span>
                            <i class="fas fa-chevron-down"></i>
                        </button>
                        <div class="custom-dropdown-menu" id="editDifficultyDropdownMenu">
                            <div class="custom-dropdown-item ${card.difficulty === 'easy' ? 'selected' : ''}" onclick="selectModalDifficulty('editDifficulty', 'easy', 'Easy')">Easy</div>
                            <div class="custom-dropdown-item ${card.difficulty === 'medium' ? 'selected' : ''}" onclick="selectModalDifficulty('editDifficulty', 'medium', 'Medium')">Medium</div>
                            <div class="custom-dropdown-item ${card.difficulty === 'hard' ? 'selected' : ''}" onclick="selectModalDifficulty('editDifficulty', 'hard', 'Hard')">Hard</div>
                        </div>
                    </div>
                    <input type="hidden" id="editDifficulty" value="${card.difficulty}">

                    <label>Tags</label>
                    <div class="tag-input-container" id="editTagsContainer">
                        <input type="text" class="tag-input" id="editTagInput" placeholder="Type and press Enter..." />
                    </div>

                    <div class="modal-actions">
                        <button type="button" class="btn-cancel" onclick="closeModal()">Cancel</button>
                        <button type="submit" class="btn-primary">Update Card</button>
                    </div>
                </form>
            </div>
        `;
        createModal(modal);

        // Initialize with existing tags
        window.flashcardTags_editTagInput = card.tags || [];
        initializeTagInput('editTagInput', 'editTagsContainer');

        // Render existing tags
        const container = document.getElementById('editTagsContainer');
        const input = document.getElementById('editTagInput');
        (card.tags || []).forEach((tag, index) => {
            const chip = document.createElement('span');
            chip.className = 'tag-chip';
            chip.innerHTML = `
                ${escapeHtml(tag)}
                <button type="button" onclick="this.parentElement.remove(); window.flashcardTags_editTagInput.splice(${index}, 1);">
                    <i class="fas fa-times"></i>
                </button>
            `;
            container.insertBefore(chip, input);
        });
    }

    async function updateCard(id) {
        const title = document.getElementById('editTitle').value.trim();
        const content = document.getElementById('editContent').value.trim();
        const difficulty = document.getElementById('editDifficulty').value;
        const tags = window.flashcardTags_editTagInput || [];

        if (!title || !content) {
            showToast('Title and content are required', 'error');
            return;
        }

        try {
            await apiRequest(`${API_BASE}/${id}`, {
                method: 'PUT',
                body: JSON.stringify({
                    title,
                    content,
                    difficulty,
                    tags
                })
            });

            showToast('Flashcard updated successfully!');
            closeModal();
            loadFlashcards();
        } catch (error) {
            showToast(error.message || 'Failed to update flashcard', 'error');
        }
    }

    // Delete modal
    function openDeleteModal(id) {
        const card = flashcards.find(c => c._id === id);
        if (!card) return;

        const modal = `
            <div class="flashcard-modal">
                <h2><i class="fas fa-trash mr-2"></i>Delete Flashcard</h2>
                <p style="color: #6b7280; margin-bottom: 1.5rem;">
                    Are you sure you want to delete this flashcard? This action cannot be undone.
                </p>
                <div style="background: #f9fafb; padding: 1rem; border-radius: 0.75rem; margin-bottom: 1.5rem;">
                    <p style="font-weight: 600; color: #1f2937; margin-bottom: 0.5rem;">
                        ${escapeHtml(card.title)}
                    </p>
                    <p style="font-size: 0.875rem; color: #6b7280;">
                        Difficulty: ${card.difficulty || 'medium'}
                    </p>
                </div>
                <div class="modal-actions">
                    <button class="btn-cancel" onclick="closeModal()">Cancel</button>
                    <button class="btn-danger" onclick="deleteCard('${id}')">Delete</button>
                </div>
            </div>
        `;
        createModal(modal);
    }

    async function deleteCard(id) {
        try {
            await apiRequest(`${API_BASE}/${id}`, { method: 'DELETE' });
            showToast('Flashcard deleted successfully!');
            closeModal();
            loadFlashcards();
        } catch (error) {
            showToast(error.message || 'Failed to delete flashcard', 'error');
        }
    }

    // Toggle functions
    async function togglePin(id) {
        try {
            await apiRequest(`${API_BASE}/${id}/pin`, { method: 'PATCH' });
            loadFlashcards();
        } catch (error) {
            showToast(error.message || 'Failed to toggle pin', 'error');
        }
    }

    async function toggleFavorite(id) {
        try {
            await apiRequest(`${API_BASE}/${id}/favorite`, { method: 'PATCH' });
            loadFlashcards();
        } catch (error) {
            showToast(error.message || 'Failed to toggle favorite', 'error');
        }
    }

    // AI Generate modal
    async function openAIGenerateModal() {
        // First, fetch user's notes
        showLoading();
        try {
            const response = await fetch('/api/v1/notes');
            const data = await response.json();
            const notes = data.data.notes || [];

            if (notes.length === 0) {
                showContent();
                showToast('No notes found. Create some notes first!', 'error');
                return;
            }

            showContent();

            const modal = `
                <div class="flashcard-modal">
                    <h2><i class="fas fa-sparkles mr-2"></i>AI Generate Flashcards</h2>
                    <p style="color: #6b7280; margin-bottom: 1.5rem;">
                        Select a note to generate flashcards from using AI.
                    </p>

                    <label>Select Note <span style="color: #dc2626;">*</span></label>
                    <div id="notesList" style="max-height: 400px; overflow-y: auto; margin-top: 0.5rem;">
                        ${notes.map(note => `
                            <div class="note-item" onclick="selectNote('${note._id}')">
                                <div class="note-title">${escapeHtml(note.title || 'Untitled')}</div>
                                <div class="note-preview">${escapeHtml((note.plainText || '').substring(0, 100))}...</div>
                            </div>
                        `).join('')}
                    </div>

                    <div class="modal-actions">
                        <button type="button" class="btn-cancel" onclick="closeModal()">Cancel</button>
                        <button type="button" class="btn-primary" id="generateBtn" disabled onclick="generateFlashcardsFromNote()">
                            <i class="fas fa-sparkles mr-2"></i>Generate Flashcards
                        </button>
                    </div>
                </div>
            `;
            createModal(modal);
        } catch (error) {
            showError(error.message || 'Failed to load notes');
            showToast('Failed to load notes', 'error');
        }
    }

    let selectedNoteId = null;

    function selectNote(noteId) {
        selectedNoteId = noteId;

        // Update UI
        document.querySelectorAll('.note-item').forEach(item => {
            item.classList.remove('selected');
        });
        event.currentTarget.classList.add('selected');

        // Enable generate button
        document.getElementById('generateBtn').disabled = false;
    }

    async function generateFlashcardsFromNote() {
        if (!selectedNoteId) {
            showToast('Please select a note first', 'error');
            return;
        }

        const btn = document.getElementById('generateBtn');
        btn.disabled = true;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Generating...';

        try {
            const response = await apiRequest(`${API_BASE}/ai`, {
                method: 'POST',
                body: JSON.stringify({ noteId: selectedNoteId })
            });

            const count = response.data.numberOfCards || response.data.cards?.length || 0;
            showToast(`Successfully generated ${count} flashcards!`);
            closeModal();

            // Wait a bit for backend to save cards, then reload
            setTimeout(() => loadFlashcards(), 1000);
        } catch (error) {
            showToast(error.message || 'Failed to generate flashcards', 'error');
            btn.disabled = false;
            btn.innerHTML = '<i class="fas fa-sparkles mr-2"></i>Generate Flashcards';
        }
    }

    // Make functions globally accessible
    window.openCreateModal = openCreateModal;
    window.openEditModal = openEditModal;
    window.openDeleteModal = openDeleteModal;
    window.openAIGenerateModal = openAIGenerateModal;
    window.createCard = createCard;
    window.updateCard = updateCard;
    window.deleteCard = deleteCard;
    window.togglePin = togglePin;
    window.toggleFavorite = toggleFavorite;
    window.generateFlashcardsFromNote = generateFlashcardsFromNote;
    window.selectNote = selectNote;
    window.closeModal = closeModal;
    window.loadFlashcards = loadFlashcards;

    // Initialize on page load
    document.addEventListener('DOMContentLoaded', () => {
        loadFlashcards();

        // Add event listeners
        document.getElementById('searchInput').addEventListener('input', handleSearch);

        // Close modal on overlay click
        const modalOverlay = document.getElementById('flashcardModalOverlay');
        if (modalOverlay) {
            modalOverlay.addEventListener('click', (e) => {
                if (e.target.id === 'flashcardModalOverlay') closeModal();
            });
        }
    });

    // Reload flashcards when navigating to flashcards section
    if (window.navigationManager) {
        const originalNavigate = window.navigationManager.navigateTo;
        window.navigationManager.navigateTo = function(index) {
            originalNavigate.call(this, index);
            if (index === 3) { // Flashcards section is index 3
                loadFlashcards();
            }
        };
    }
</script>
